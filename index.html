<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sá»• Theo DÃµi Thi Äua - Lá»›p 6B0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
    .award-card { background:#fff; border-radius:12px; padding:1rem; box-shadow:0 4px 6px rgba(0,0,0,.1); transition:transform .2s }
    .award-card:hover { transform:translateY(-4px) }
  </style>
</head>
<body class="p-4 md:p-6">

  <!-- Header -->
  <div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl shadow-lg p-6 mb-6">
    <h1 class="text-4xl font-extrabold">ğŸ“˜ Sá»• Theo DÃµi Thi Äua - Lá»›p 6B0</h1>
    <p class="text-indigo-200 mt-1 text-lg">NÄƒm há»c 2025 - 2026</p>
  </div>

  <!-- Controls -->
  <div class="flex flex-wrap items-center gap-3 mb-6">
    <select id="month-select" class="p-2 rounded border border-gray-300"></select>
    <select id="week-select" class="p-2 rounded border border-gray-300"></select>
    <button onclick="exportExcel('week')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow">ğŸ“¥ Xuáº¥t Excel (Tuáº§n)</button>
    <button onclick="exportExcel('month')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">ğŸ“¥ Xuáº¥t Excel (ThÃ¡ng)</button>
  </div>

  <!-- Student Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border rounded-xl overflow-hidden shadow">
      <thead class="bg-indigo-50">
        <tr>
          <th class="px-4 py-2 text-left font-bold">Há»c sinh</th>
          <th class="px-4 py-2 text-center font-bold w-24">Äiá»ƒm</th>
          <th class="px-4 py-2 text-center font-bold w-32">Xáº¿p loáº¡i</th>
          <th class="px-4 py-2 font-bold">ğŸ‘ Æ¯u Ä‘iá»ƒm</th>
          <th class="px-4 py-2 font-bold">âœï¸ Cáº§n cá»‘ gáº¯ng</th>
          <th class="px-4 py-2 text-center font-bold">âœ¨ Nháº­n xÃ©t CÃ´ Hoa</th>
        </tr>
      </thead>
      <tbody id="student-table-body" class="divide-y divide-gray-200 bg-white"></tbody>
    </table>
  </div>

  <!-- Awards Section -->
  <div class="mt-10 text-center">
    <button onclick="generateAwards()" class="bg-gradient-to-r from-amber-400 to-orange-500 text-white px-6 py-3 rounded-lg font-bold shadow hover:scale-105">ğŸ† Tá»•ng káº¿t & Trao danh hiá»‡u tuáº§n</button>
    <div id="awards-container" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    // Danh sÃ¡ch HS (57 + Huy, TrÃ­)
    const studentList = [
      "Nguyá»…n Äáº·ng Minh An","Cung Äá»©c Anh","Tráº§n Quá»³nh Anh","Nguyá»…n Diá»‡p Anh","HoÃ ng Mai Anh","Nguyá»…n Huy Báº£o Anh",
      "Nguyá»…n Gia Báº£o","Trá»‹nh Quang Báº£o","Láº¡i Tháº£o Chi","Pháº¡m Lam Chi","Nguyá»…n KhÃ¡nh Chi","Nguyá»…n Äá»— Minh ChÃ­",
      "Pháº¡m KhÆ°Æ¡ng Duy","Tráº§n NguyÃªn Duy","Äá»— Quá»‘c Äáº¡t","LÃª Tiáº¿n Äáº¡t","QuÃ¡ch Trung Äá»©c","Pháº¡m Minh Äá»©c",
      "Láº¡i Tiáº¿n Äá»©c","Tráº§n Ngá»c HÃ¢n","Cao HoÃ ng","Cung Äá»©c Huy","Nguyá»…n Minh KhuÃª","HoÃ ng Mi Lan",
      "VÅ© My Lan","ÄÃ m Gia Linh","LÃª Tháº£o Linh","Äáº·ng ThÃ nh Minh","VÆ°Æ¡ng Quang Minh","VÅ© Tráº§n Tiáº¿n Minh",
      "Äáº§u Äáº¡i Minh","Äáº·ng Gia Minh","NgÃ´ HoÃ ng My","Äáº·ng Kim NgÃ¢n","Nguyá»…n KhÃ¡nh Ngá»c","BÃ¹i Báº£o NguyÃªn",
      "LÃ½ HoÃ ng Minh Nháº­t","NgÃ´ Háº£i Minh","DÆ°Æ¡ng Yáº¿n Nhi","VÅ© KhÃ¡nh Nhi","Trá»‹nh Nam Phong","Nguyá»…n HÃ  PhÆ°Æ¡ng",
      "DÆ°Æ¡ng Äáº¡i Quang","Mai Tiáº¿n ThÃ nh","Tráº§n Ngá»c Tháº£o","Äáº·ng Anh ThÆ°","Nguyá»…n Quang Thiá»‡n","Nguyá»…n ÄÃ¬nh Thi",
      "Tráº§n PhÆ°Æ¡ng Tháº£o","Trá»‹nh Ngá»c Minh Trang","Nguyá»…n Báº£o TrÃ¢m","Nguyá»…n Äá»©c TrÃ­","Tráº§n Trung","Tráº§n Quang Vinh",
      "LÆ°Æ¡ng UyÃªn Báº£o TrÃ¢n","Nguyá»…n Quang Vinh","Nguyá»…n Minh TrÃ­","Nguyá»…n Quang Huy"
    ];

    const months = ["ThÃ¡ng 9","ThÃ¡ng 10","ThÃ¡ng 11","ThÃ¡ng 12","ThÃ¡ng 1","ThÃ¡ng 2","ThÃ¡ng 3","ThÃ¡ng 4","ThÃ¡ng 5"];
    const weeks = ["Tuáº§n 1","Tuáº§n 2","Tuáº§n 3","Tuáº§n 4","Tuáº§n 5"];

    let studentData = {};

    // Xáº¿p loáº¡i
    function getRanking(score) {
      if (score === null || score === "") return { rank:"ChÆ°a cÃ³", color:"bg-gray-200 text-gray-700" };
      if (score >= 87) return { rank:"Xuáº¥t sáº¯c", color:"bg-green-100 text-green-800" };
      if (score >= 80) return { rank:"Tá»‘t", color:"bg-blue-100 text-blue-800" };
      if (score >= 65) return { rank:"KhÃ¡", color:"bg-yellow-100 text-yellow-800" };
      if (score >= 50) return { rank:"Äáº¡t", color:"bg-orange-100 text-orange-800" };
      return { rank:"ChÆ°a Ä‘áº¡t", color:"bg-red-100 text-red-800" };
    }

    // Render báº£ng
    const monthSelect=document.getElementById("month-select");
    const weekSelect=document.getElementById("week-select");
    const tableBody=document.getElementById("student-table-body");

    months.forEach(m => { let o=document.createElement("option"); o.value=m;o.textContent=m;monthSelect.appendChild(o); });
    weeks.forEach(w => { let o=document.createElement("option"); o.value=w;o.textContent=w;weekSelect.appendChild(o); });

    function renderTable(){
      const m=monthSelect.value, w=weekSelect.value;
      tableBody.innerHTML="";
      studentList.forEach(name=>{
        const d=studentData?.[name]?.[m]?.[w] || {score:null, adv:"", iss:"", advice:""};
        const ranking=getRanking(d.score);
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td class="px-4 py-2">${name}</td>
          <td class="px-2 py-2 text-center">
            <input type="number" value="${d.score??""}" class="w-20 p-1 border rounded text-center"
              onchange="updateData('${name}','score',this.value)">
          </td>
          <td class="px-2 py-2 text-center">
            <span class="px-2 py-1 rounded-full ${ranking.color}">${ranking.rank}</span>
          </td>
          <td class="px-2 py-2"><textarea class="w-full border rounded p-1 text-green-800" rows="2"
            onchange="updateData('${name}','adv',this.value)">${d.adv||""}</textarea></td>
          <td class="px-2 py-2"><textarea class="w-full border rounded p-1 text-pink-600" rows="2"
            onchange="updateData('${name}','iss',this.value)">${d.iss||""}</textarea></td>
          <td class="px-2 py-2 text-center">
            <button onclick="getAdvice('${name}')" class="text-2xl hover:scale-125 transition">âœ¨</button>
          </td>`;
        tableBody.appendChild(tr);
      });
    }

    // Cáº­p nháº­t dá»¯ liá»‡u tá»«ng field (khÃ´ng ghi Ä‘Ã¨ toÃ n bá»™)
    window.updateData = async (name,field,value)=>{
      const m=monthSelect.value, w=weekSelect.value;
      if(field==="score") value=value===""?null:Number(value);
      if (!studentData[name]) studentData[name] = {};
      if (!studentData[name][m]) studentData[name][m] = {};
      if (!studentData[name][m][w]) studentData[name][m][w] = {score:null,adv:"",iss:"",advice:""};
      studentData[name][m][w][field]=value;
      await updateDoc(dataDocRef,{[`studentData.${name}.${m}.${w}.${field}`]:value});
      renderTable();
    };

    // Sinh nháº­n xÃ©t
    function generateAdvice(adv,iss){
      let msg="";
      if(adv) msg+=`CÃ´ khen con ${adv}. `;
      if(iss) msg+=`Con cáº§n chÃº Ã½: ${iss}. `;
      if(!adv && !iss) msg="CÃ´ mong con sáº½ cá»‘ gáº¯ng hÆ¡n ná»¯a trong tuáº§n tá»›i!";
      return msg.trim();
    }
    window.getAdvice=async (name)=>{
      const m=monthSelect.value,w=weekSelect.value;
      const d=studentData[name]?.[m]?.[w]||{adv:"",iss:""};
      const advice=generateAdvice(d.adv,d.iss);
      alert(`Nháº­n xÃ©t cá»§a CÃ´ Hoa:\n\n${advice}`);
      await updateDoc(dataDocRef,{[`studentData.${name}.${m}.${w}.advice`]:advice});
    };

    // Nghe realtime
    onSnapshot(dataDocRef,(snap)=>{
      if(snap.exists()) studentData=snap.data().studentData||{};
      else studentData={};
      renderTable();
    });

    monthSelect.value=months[0]; weekSelect.value=weeks[0];
    monthSelect.onchange=renderTable; weekSelect.onchange=renderTable;

    // Xuáº¥t Excel
    window.exportExcel=(type)=>{
      const m=monthSelect.value,w=weekSelect.value;
      let aoa=[["STT","Há» vÃ  tÃªn","Äiá»ƒm","Xáº¿p loáº¡i","Æ¯u Ä‘iá»ƒm","Cáº§n cá»‘ gáº¯ng","Nháº­n xÃ©t CÃ´ Hoa"]];
      let i=1;
      studentList.forEach(name=>{
        if(studentData[name] && studentData[name][m]){
          if(type==="week"){
            const d=studentData[name][m][w]; if(!d) return;
            aoa.push([i++,name,d.score,getRanking(d.score).rank,d.adv,d.iss,d.advice||""]);
          } else {
            weeks.forEach(ww=>{
              const d=studentData[name][m][ww]; if(!d) return;
              aoa.push([i++,name,d.score,getRanking(d.score).rank,d.adv,d.iss,d.advice||""]);
            });
          }
        }
      });
      const ws=XLSX.utils.aoa_to_sheet(aoa); const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"Thi Ä‘ua");
      XLSX.writeFile(wb,`ThiDua_${m}_${type}.xlsx`);
    };

    // Danh hiá»‡u
    const awardsContainer=document.getElementById("awards-container");
    window.generateAwards=()=>{
      const m=monthSelect.value,w=weekSelect.value;
      let awards={excellent:[],hardworking:[],disciplined:[]};
      studentList.forEach(name=>{
        const d=studentData[name]?.[m]?.[w]; if(!d) return;
        if(d.score>=87) awards.excellent.push(name);
        if(d.adv?.toLowerCase().includes("phÃ¡t biá»ƒu")||d.adv?.includes("10")) awards.hardworking.push(name);
        if(!d.iss) awards.disciplined.push(name);
      });
      awardsContainer.innerHTML="";
      const arr=[
        {id:"excellent",title:"NgÃ´i sao há»c táº­p â­",list:awards.excellent},
        {id:"hardworking",title:"Ong chÄƒm chá»‰ ğŸ",list:awards.hardworking},
        {id:"disciplined",title:"Hiá»‡p sÄ© ná» náº¿p ğŸ›¡ï¸",list:awards.disciplined}
      ];
      arr.forEach(a=>{
        const card=document.createElement("div"); card.className="award-card";
        let html=`<h3 class="font-bold mb-2">${a.title}</h3>`;
        html+=a.list.length? `<ul>${a.list.map(n=>`<li>${n}</li>`).join("")}</ul>` : `<p class="text-gray-400 italic">ChÆ°a cÃ³</p>`;
        card.innerHTML=html; awardsContainer.appendChild(card);
      });
    };
  </script>
</body>
</html>
