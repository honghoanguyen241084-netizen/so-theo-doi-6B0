<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sổ Theo Dõi Thi Đua - Lớp 6B0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="p-6 bg-gray-100">
  <h1 class="text-3xl font-bold mb-4 text-center">Sổ Theo Dõi Thi Đua (Lớp 6B0)</h1>

  <div class="mb-4 flex gap-4 justify-center">
    <select id="month-select" class="border p-2 rounded"></select>
    <select id="week-select" class="border p-2 rounded"></select>
    <button onclick="exportExcel('week')" class="bg-blue-500 text-white px-4 py-2 rounded">Xuất Excel (Tuần)</button>
    <button onclick="exportExcel('month')" class="bg-green-500 text-white px-4 py-2 rounded">Xuất Excel (Tháng)</button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border" id="student-table">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2">Học sinh</th>
          <th class="p-2">Điểm</th>
          <th class="p-2">Ưu điểm</th>
          <th class="p-2">Cần cố gắng</th>
        </tr>
      </thead>
      <tbody id="student-table-body"></tbody>
    </table>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // ⚡ Thay cấu hình này bằng Firebase config của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    const months = ["Tháng 9","Tháng 10","Tháng 11","Tháng 12","Tháng 1","Tháng 2","Tháng 3","Tháng 4","Tháng 5"];
    const weeks = ["Tuần 1","Tuần 2","Tuần 3","Tuần 4","Tuần 5"];

    // ✅ Danh sách 57 học sinh từ file Excel
    const studentList = [
      { name: "Nguyễn Đặng Minh An", gender: "Nữ" }, { name: "Cung Đức Anh", gender: "Nam" }, { name: "Trần Quỳnh Anh", gender: "Nữ" },
      { name: "Nguyễn Diệp Anh", gender: "Nữ" }, { name: "Hoàng Mai Anh", gender: "Nữ" }, { name: "Nguyễn Huy Bảo Anh", gender: "Nam" },
      { name: "Nguyễn Gia Bảo", gender: "Nam" }, { name: "Trịnh Quang Bảo", gender: "Nam" }, { name: "Lại Thảo Chi", gender: "Nữ" },
      { name: "Phạm Lam Chi", gender: "Nữ" }, { name: "Nguyễn Khánh Chi", gender: "Nữ" }, { name: "Nguyễn Đỗ Minh Chí", gender: "Nam" },
      { name: "Phạm Khương Duy", gender: "Nam" }, { name: "Trần Nguyên Duy", gender: "Nam" }, { name: "Đỗ Quốc Đạt", gender: "Nam" },
      { name: "Lê Tiến Đạt", gender: "Nam" }, { name: "Quách Trung Đức", gender: "Nam" }, { name: "Phạm Minh Đức", gender: "Nam" },
      { name: "Lại Tiến Đức", gender: "Nam" }, { name: "Trần Ngọc Hân", gender: "Nữ" }, { name: "Cao Hoàng", gender: "Nam" },
      { name: "Cung Đức Huy", gender: "Nam" }, { name: "Nguyễn Minh Khuê", gender: "Nữ" }, { name: "Hoàng Mi Lan", gender: "Nữ" },
      { name: "Vũ My Lan", gender: "Nữ" }, { name: "Đàm Gia Linh", gender: "Nữ" }, { name: "Lê Thảo Linh", gender: "Nữ" },
      { name: "Đặng Thành Minh", gender: "Nam" }, { name: "Vương Quang Minh", gender: "Nam" }, { name: "Vũ Trần Tiến Minh", gender: "Nam" },
      { name: "Đầu Đại Minh", gender: "Nam" }, { name: "Đặng Gia Minh", gender: "Nam" }, { name: "Ngô Hoàng My", gender: "Nữ" },
      { name: "Đặng Kim Ngân", gender: "Nữ" }, { name: "Nguyễn Khánh Ngọc", gender: "Nữ" }, { name: "Bùi Bảo Nguyên", gender: "Nam" },
      { name: "Lý Hoàng Minh Nhật", gender: "Nam" }, { name: "Ngô Hải Minh", gender: "Nam" }, { name: "Dương Yến Nhi", gender: "Nữ" },
      { name: "Vũ Khánh Nhi", gender: "Nữ" }, { name: "Trịnh Nam Phong", gender: "Nam" }, { name: "Nguyễn Hà Phương", gender: "Nữ" },
      { name: "Dương Đại Quang", gender: "Nam" }, { name: "Mai Tiến Thành", gender: "Nam" }, { name: "Trần Ngọc Thảo", gender: "Nữ" },
      { name: "Đặng Anh Thư", gender: "Nữ" }, { name: "Nguyễn Quang Thiện", gender: "Nam" }, { name: "Nguyễn Đình Thi", gender: "Nam" },
      { name: "Trần Phương Thảo", gender: "Nữ" }, { name: "Trịnh Ngọc Minh Trang", gender: "Nữ" }, { name: "Nguyễn Bảo Trâm", gender: "Nữ" },
      { name: "Nguyễn Đức Trí", gender: "Nam" }, { name: "Trần Trung", gender: "Nam" }, { name: "Trần Quang Vinh", gender: "Nam" },
      { name: "Lương Uyên Bảo Trân", gender: "Nữ" }, { name: "Nguyễn Quang Vinh", gender: "Nam" }
    ];

    let studentData = {};

    function populateSelectors(){
      const monthSelect = document.getElementById("month-select");
      const weekSelect = document.getElementById("week-select");
      months.forEach(m=>{let o=document.createElement("option");o.value=m;o.textContent=m;monthSelect.appendChild(o);});
      weeks.forEach(w=>{let o=document.createElement("option");o.value=w;o.textContent=w;weekSelect.appendChild(o);});
      monthSelect.value = months[0];
      weekSelect.value = weeks[0];
      monthSelect.onchange=renderTable;
      weekSelect.onchange=renderTable;
    }

    function renderTable(){
      const tbody=document.getElementById("student-table-body");
      tbody.innerHTML="";
      const m=document.getElementById("month-select").value;
      const w=document.getElementById("week-select").value;

      studentList.forEach((s)=>{
        if(!studentData[s.name]) studentData[s.name]={};
        if(!studentData[s.name][m]) studentData[s.name][m]={};
        if(!studentData[s.name][m][w]) studentData[s.name][m][w]={score:null,advantages:"",issues:""};

        const data=studentData[s.name][m][w];
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td class="border p-2">
            <input type="text" value="${s.name}" class="border p-1 w-full"
              onchange="updateName('${s.name}',this.value)">
          </td>
          <td class="border p-2"><input type="number" value="${data.score??''}" class="border p-1 w-20" onchange="updateData('${s.name}','score',this.value)"></td>
          <td class="border p-2"><textarea class="border p-1 w-full" onchange="updateData('${s.name}','advantages',this.value)">${data.advantages}</textarea></td>
          <td class="border p-2"><textarea class="border p-1 w-full" onchange="updateData('${s.name}','issues',this.value)">${data.issues}</textarea></td>`;
        tbody.appendChild(tr);
      });
    }

    window.updateData = (studentName,field,value)=>{
      const m=document.getElementById("month-select").value;
      const w=document.getElementById("week-select").value;
      if(field==="score") value=value===""?null:Number(value);
      studentData[studentName][m][w][field]=value;
      save();
    };

    window.updateName = (oldName,newName)=>{
      if(!newName.trim()) return;
      studentData[newName]=studentData[oldName];
      delete studentData[oldName];
      save();
      renderTable();
    };

    async function save(){
      await setDoc(dataDocRef,{studentData},{merge:true});
    }

    function listen(){
      onSnapshot(dataDocRef,(snap)=>{
        if(snap.exists()){
          studentData=snap.data().studentData||{};
          renderTable();
        } else {
          studentData={};
          renderTable();
        }
      });
    }

    window.exportExcel = async (type) => {
      const m=document.getElementById("month-select").value;
      const w=document.getElementById("week-select").value;
      const dataToExport=[];
      const header=["STT","Họ và Tên","Điểm","Ưu điểm","Cần cố gắng"];
      if(type==="month") header.splice(2,0,"Tuần");
      dataToExport.push(header);
      let stt=1;
      for(const s of studentList){
        if(studentData[s.name]){
          if(type==="week"){
            const d=studentData[s.name][m][w];
            if(d) dataToExport.push([stt++,s.name,d.score??"",d.advantages,d.issues]);
          }else{
            for(const wk of weeks){
              const d=studentData[s.name][m][wk];
              if(d) dataToExport.push([stt++,s.name,wk,d.score??"",d.advantages,d.issues]);
            }
          }
        }
      }
      const ws=XLSX.utils.aoa_to_sheet(dataToExport);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"ThiDua");
      XLSX.writeFile(wb,`ThiDua_${m.replace(" ","_")}_${type}.xlsx`);
    };

    document.addEventListener("DOMContentLoaded",()=>{
      populateSelectors();
      listen();
    });
  </script>
</body>
</html>
