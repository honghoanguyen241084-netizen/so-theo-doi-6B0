<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sá»• Theo DÃµi Thi Äua - Lá»›p 6B0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="p-6 bg-gradient-to-r from-pink-50 via-purple-50 to-blue-50 min-h-screen">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-extrabold text-indigo-700">ğŸ“˜ Sá»• Theo DÃµi Thi Äua (Lá»›p 6B0)</h1>
    <p class="text-gray-600 mt-2">NÄƒm há»c 2024 - 2025</p>
  </div>

  <!-- Controls -->
  <div class="flex flex-wrap gap-4 justify-center mb-6">
    <select id="month-select" class="border p-2 rounded-lg shadow bg-white"></select>
    <select id="week-select" class="border p-2 rounded-lg shadow bg-white"></select>
    <button onclick="exportExcel('week')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow">Xuáº¥t Excel (Tuáº§n)</button>
    <button onclick="exportExcel('month')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">Xuáº¥t Excel (ThÃ¡ng)</button>
  </div>

  <!-- Student Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border rounded-xl shadow-lg" id="student-table">
      <thead class="bg-indigo-100 text-indigo-800">
        <tr>
          <th class="p-2">Há»c sinh</th>
          <th class="p-2 w-28">Äiá»ƒm</th>
          <th class="p-2 w-32">Xáº¿p loáº¡i</th>
          <th class="p-2 w-64">Æ¯u Ä‘iá»ƒm</th>
          <th class="p-2 w-64">Cáº§n cá»‘ gáº¯ng</th>
        </tr>
      </thead>
      <tbody id="student-table-body"></tbody>
    </table>
  </div>

  <!-- Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // ğŸ”‘ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    const months = ["ThÃ¡ng 9","ThÃ¡ng 10","ThÃ¡ng 11","ThÃ¡ng 12","ThÃ¡ng 1","ThÃ¡ng 2","ThÃ¡ng 3","ThÃ¡ng 4","ThÃ¡ng 5"];
    const weeks = ["Tuáº§n 1","Tuáº§n 2","Tuáº§n 3","Tuáº§n 4","Tuáº§n 5"];

    // âœ… Danh sÃ¡ch 57 há»c sinh chuáº©n tá»« Excel
    const studentList = [
      { name: "Nguyá»…n Äáº·ng Minh An", gender: "Ná»¯" }, { name: "Cung Äá»©c Anh", gender: "Nam" }, { name: "Tráº§n Quá»³nh Anh", gender: "Ná»¯" },
      { name: "Nguyá»…n Diá»‡p Anh", gender: "Ná»¯" }, { name: "HoÃ ng Mai Anh", gender: "Ná»¯" }, { name: "Nguyá»…n Huy Báº£o Anh", gender: "Nam" },
      { name: "Nguyá»…n Gia Báº£o", gender: "Nam" }, { name: "Trá»‹nh Quang Báº£o", gender: "Nam" }, { name: "Láº¡i Tháº£o Chi", gender: "Ná»¯" },
      { name: "Pháº¡m Lam Chi", gender: "Ná»¯" }, { name: "Nguyá»…n KhÃ¡nh Chi", gender: "Ná»¯" }, { name: "Nguyá»…n Äá»— Minh ChÃ­", gender: "Nam" },
      { name: "Pháº¡m KhÆ°Æ¡ng Duy", gender: "Nam" }, { name: "Tráº§n NguyÃªn Duy", gender: "Nam" }, { name: "Äá»— Quá»‘c Äáº¡t", gender: "Nam" },
      { name: "LÃª Tiáº¿n Äáº¡t", gender: "Nam" }, { name: "QuÃ¡ch Trung Äá»©c", gender: "Nam" }, { name: "Pháº¡m Minh Äá»©c", gender: "Nam" },
      { name: "Láº¡i Tiáº¿n Äá»©c", gender: "Nam" }, { name: "Tráº§n Ngá»c HÃ¢n", gender: "Ná»¯" }, { name: "Cao HoÃ ng", gender: "Nam" },
      { name: "Cung Äá»©c Huy", gender: "Nam" }, { name: "Nguyá»…n Minh KhuÃª", gender: "Ná»¯" }, { name: "HoÃ ng Mi Lan", gender: "Ná»¯" },
      { name: "VÅ© My Lan", gender: "Ná»¯" }, { name: "ÄÃ m Gia Linh", gender: "Ná»¯" }, { name: "LÃª Tháº£o Linh", gender: "Ná»¯" },
      { name: "Äáº·ng ThÃ nh Minh", gender: "Nam" }, { name: "VÆ°Æ¡ng Quang Minh", gender: "Nam" }, { name: "VÅ© Tráº§n Tiáº¿n Minh", gender: "Nam" },
      { name: "Äáº§u Äáº¡i Minh", gender: "Nam" }, { name: "Äáº·ng Gia Minh", gender: "Nam" }, { name: "NgÃ´ HoÃ ng My", gender: "Ná»¯" },
      { name: "Äáº·ng Kim NgÃ¢n", gender: "Ná»¯" }, { name: "Nguyá»…n KhÃ¡nh Ngá»c", gender: "Ná»¯" }, { name: "BÃ¹i Báº£o NguyÃªn", gender: "Nam" },
      { name: "LÃ½ HoÃ ng Minh Nháº­t", gender: "Nam" }, { name: "NgÃ´ Háº£i Minh", gender: "Nam" }, { name: "DÆ°Æ¡ng Yáº¿n Nhi", gender: "Ná»¯" },
      { name: "VÅ© KhÃ¡nh Nhi", gender: "Ná»¯" }, { name: "Trá»‹nh Nam Phong", gender: "Nam" }, { name: "Nguyá»…n HÃ  PhÆ°Æ¡ng", gender: "Ná»¯" },
      { name: "DÆ°Æ¡ng Äáº¡i Quang", gender: "Nam" }, { name: "Mai Tiáº¿n ThÃ nh", gender: "Nam" }, { name: "Tráº§n Ngá»c Tháº£o", gender: "Ná»¯" },
      { name: "Äáº·ng Anh ThÆ°", gender: "Ná»¯" }, { name: "Nguyá»…n Quang Thiá»‡n", gender: "Nam" }, { name: "Nguyá»…n ÄÃ¬nh Thi", gender: "Nam" },
      { name: "Tráº§n PhÆ°Æ¡ng Tháº£o", gender: "Ná»¯" }, { name: "Trá»‹nh Ngá»c Minh Trang", gender: "Ná»¯" }, { name: "Nguyá»…n Báº£o TrÃ¢m", gender: "Ná»¯" },
      { name: "NguyÃªÌƒn ÄÆ°Ìc TriÌ", gender: "Nam" }, { name: "Tráº§n Trung", gender: "Nam" }, { name: "Tráº§n Quang Vinh", gender: "Nam" },
      { name: "LÆ°Æ¡ng UyÃªn Báº£o TrÃ¢n", gender: "Ná»¯" }, { name: "Nguyá»…n Quang Vinh", gender: "Nam" }
    ];

    let studentData = {};

    function populateSelectors(){
      const monthSelect=document.getElementById("month-select");
      const weekSelect=document.getElementById("week-select");
      months.forEach(m=>{let o=document.createElement("option");o.value=m;o.textContent=m;monthSelect.appendChild(o);});
      weeks.forEach(w=>{let o=document.createElement("option");o.value=w;o.textContent=w;weekSelect.appendChild(o);});
      monthSelect.value=months[0]; weekSelect.value=weeks[0];
      monthSelect.onchange=renderTable; weekSelect.onchange=renderTable;
    }

    function getRank(score){
      if(score===null||score==="") return {text:"ChÆ°a cÃ³",color:"bg-gray-200 text-gray-600"};
      if(score>=87) return {text:"Xuáº¥t sáº¯c",color:"bg-green-200 text-green-800"};
      if(score>=80) return {text:"Tá»‘t",color:"bg-blue-200 text-blue-800"};
      if(score>=65) return {text:"KhÃ¡",color:"bg-yellow-200 text-yellow-800"};
      if(score>=50) return {text:"Äáº¡t",color:"bg-orange-200 text-orange-800"};
      return {text:"ChÆ°a Ä‘áº¡t",color:"bg-red-200 text-red-800"};
    }

    function renderTable(){
      const tbody=document.getElementById("student-table-body");
      tbody.innerHTML="";
      const m=document.getElementById("month-select").value;
      const w=document.getElementById("week-select").value;

      studentList.forEach((s)=>{
        if(!studentData[s.name]) studentData[s.name]={};
        if(!studentData[s.name][m]) studentData[s.name][m]={};
        if(!studentData[s.name][m][w]) studentData[s.name][m][w]={score:null,advantages:"",issues:""};

        const d=studentData[s.name][m][w];
        const rank=getRank(d.score);
        const tr=document.createElement("tr");
        tr.className="hover:bg-indigo-50";
        tr.innerHTML=`
          <td class="border p-2 bg-slate-50">
            <input type="text" value="${s.name}" class="border p-1 w-full rounded"
              onchange="updateName('${s.name}',this.value)">
          </td>
          <td class="border p-2 text-center">
            <input type="number" value="${d.score??''}" class="border p-1 w-24 text-center rounded font-semibold"
              onchange="updateData('${s.name}','score',this.value)">
          </td>
          <td class="border p-2 text-center">
            <span class="px-3 py-1 rounded-full text-sm ${rank.color}">${rank.text}</span>
          </td>
          <td class="border p-2 bg-green-50">
            <textarea class="border p-1 w-full rounded" onchange="updateData('${s.name}','advantages',this.value)">${d.advantages}</textarea>
          </td>
          <td class="border p-2 bg-pink-50">
            <textarea class="border p-1 w-full rounded" onchange="updateData('${s.name}','issues',this.value)">${d.issues}</textarea>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.updateData=(studentName,field,value)=>{
      const m=document.getElementById("month-select").value;
      const w=document.getElementById("week-select").value;
      if(field==="score") value=value===""?null:Number(value);
      studentData[studentName][m][w][field]=value;
      save();
      renderTable();
    };

    window.updateName=(oldName,newName)=>{
      if(!newName.trim()) return;
      studentData[newName]=studentData[oldName];
      delete studentData[oldName];
      save();
      renderTable();
    };

    async function save(){
      await setDoc(dataDocRef,{studentData},{merge:true});
    }

    function listen(){
      onSnapshot(dataDocRef,(snap)=>{
        if(snap.exists()){ studentData=snap.data().studentData||{}; renderTable(); }
        else { studentData={}; renderTable(); }
      });
    }

    window.exportExcel=(type)=>{
      const m=document.getElementById("month-select").value;
      const w=document.getElementById("week-select").value;
      const dataToExport=[];
      const header=["STT","Há» vÃ  TÃªn","Äiá»ƒm","Xáº¿p loáº¡i","Æ¯u Ä‘iá»ƒm","Cáº§n cá»‘ gáº¯ng"];
      if(type==="month") header.splice(2,0,"Tuáº§n");
      dataToExport.push(header);
      let stt=1;
      for(const s of studentList){
        if(studentData[s.name]){
          if(type==="week"){
            const d=studentData[s.name][m][w];
            if(d){ dataToExport.push([stt++,s.name,d.score??"",getRank(d.score).text,d.advantages,d.issues]); }
          }else{
            for(const wk of weeks){
              const d=studentData[s.name][m][wk];
              if(d){ dataToExport.push([stt++,s.name,wk,d.score??"",getRank(d.score).text,d.advantages,d.issues]); }
            }
          }
        }
      }
      const ws=XLSX.utils.aoa_to_sheet(dataToExport);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"ThiDua");
      XLSX.writeFile(wb,`ThiDua_${m.replace(" ","_")}_${type}.xlsx`);
    };

    document.addEventListener("DOMContentLoaded",()=>{ populateSelectors(); listen(); });
  </script>
</body>
</html>
