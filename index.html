<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sá»• Theo DÃµi Thi Äua - Lá»›p 6B0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f9fafb; }
    textarea { min-height: 48px; }
  </style>
</head>

<body class="p-4 md:p-6">
  <div id="app" class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-2xl shadow-lg p-6 mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold">ğŸ“˜ Sá»• Theo DÃµi Thi Äua - Lá»›p 6B0</h1>
      <p class="text-indigo-100 mt-2">NÄƒm há»c 2024 - 2025</p>
    </div>

    <!-- Controls -->
    <div class="flex flex-wrap gap-3 justify-center mb-6">
      <select id="month-select" class="border p-2 rounded-lg shadow bg-white"></select>
      <select id="week-select" class="border p-2 rounded-lg shadow bg-white"></select>
      <button onclick="exportExcel('week')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow">ğŸ“¤ Xuáº¥t Excel (Tuáº§n)</button>
      <button onclick="exportExcel('month')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">ğŸ“¤ Xuáº¥t Excel (ThÃ¡ng)</button>
    </div>

    <!-- Student Table -->
    <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-indigo-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Há»c sinh</th>
            <th class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase">Äiá»ƒm</th>
            <th class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase">Xáº¿p loáº¡i</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">ğŸ‘ Æ¯u Ä‘iá»ƒm</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">âœï¸ Cáº§n cá»‘ gáº¯ng</th>
          </tr>
        </thead>
        <tbody id="student-table-body" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    // Danh sÃ¡ch 57 HS (chuáº©n tá»« file) + Nguyá»…n Minh TrÃ­, Nguyá»…n Quang Huy
    const studentList = [
      "Nguyá»…n Äáº·ng Minh An","Cung Äá»©c Anh","Tráº§n Quá»³nh Anh","Nguyá»…n Diá»‡p Anh","HoÃ ng Mai Anh",
      "Nguyá»…n Huy Báº£o Anh","Nguyá»…n Gia Báº£o","Trá»‹nh Quang Báº£o","Láº¡i Tháº£o Chi","Pháº¡m Lam Chi",
      "Nguyá»…n KhÃ¡nh Chi","Nguyá»…n Äá»— Minh ChÃ­","Pháº¡m KhÆ°Æ¡ng Duy","Tráº§n NguyÃªn Duy","Äá»— Quá»‘c Äáº¡t",
      "LÃª Tiáº¿n Äáº¡t","QuÃ¡ch Trung Äá»©c","Pháº¡m Minh Äá»©c","Láº¡i Tiáº¿n Äá»©c","Tráº§n Ngá»c HÃ¢n",
      "Cao HoÃ ng","Cung Äá»©c Huy","Nguyá»…n Minh KhuÃª","HoÃ ng Mi Lan","VÅ© My Lan",
      "ÄÃ m Gia Linh","LÃª Tháº£o Linh","Äáº·ng ThÃ nh Minh","VÆ°Æ¡ng Quang Minh","VÅ© Tráº§n Tiáº¿n Minh",
      "Äáº§u Äáº¡i Minh","Äáº·ng Gia Minh","NgÃ´ HoÃ ng My","Äáº·ng Kim NgÃ¢n","Nguyá»…n KhÃ¡nh Ngá»c",
      "BÃ¹i Báº£o NguyÃªn","LÃ½ HoÃ ng Minh Nháº­t","NgÃ´ Háº£i Minh","DÆ°Æ¡ng Yáº¿n Nhi","VÅ© KhÃ¡nh Nhi",
      "Trá»‹nh Nam Phong","Nguyá»…n HÃ  PhÆ°Æ¡ng","DÆ°Æ¡ng Äáº¡i Quang","Mai Tiáº¿n ThÃ nh","Tráº§n Ngá»c Tháº£o",
      "Äáº·ng Anh ThÆ°","Nguyá»…n Quang Thiá»‡n","Nguyá»…n ÄÃ¬nh Thi","Tráº§n PhÆ°Æ¡ng Tháº£o","Trá»‹nh Ngá»c Minh Trang",
      "Nguyá»…n Báº£o TrÃ¢m","NguyÃªÌƒn ÄÆ°Ìc TriÌ","Nguyá»…n Minh TrÃ­","Nguyá»…n Quang Huy","Tráº§n Trung",
      "Tráº§n Quang Vinh","LÆ°Æ¡ng UyÃªn Báº£o TrÃ¢n","Nguyá»…n Quang Vinh"
    ];

    const months = Array.from({ length: 9 }, (_, i) => `ThÃ¡ng ${i + 9 > 12 ? i + 9 - 12 : i + 9}`);
    const weeks = ["Tuáº§n 1","Tuáº§n 2","Tuáº§n 3","Tuáº§n 4","Tuáº§n 5"];
    let studentData = {};

    function generateInitialData() {
      const initial = {};
      studentList.forEach(n => {
        initial[n] = {};
        months.forEach(m => {
          initial[n][m] = {};
          weeks.forEach(w => {
            initial[n][m][w] = { score: null, advantages: "", issues: "" };
          });
        });
      });
      return initial;
    }

    function getRanking(score) {
      if (score === null || score === "") return "ChÆ°a cÃ³";
      if (score >= 87) return "Xuáº¥t sáº¯c";
      if (score >= 80) return "Tá»‘t";
      if (score >= 65) return "KhÃ¡";
      if (score >= 50) return "Äáº¡t";
      return "ChÆ°a Ä‘áº¡t";
    }

    async function save() {
      await setDoc(dataDocRef, { studentData }, { merge: true });
    }

    function listenForDataChanges() {
      onSnapshot(dataDocRef, (docSnap) => {
        if (docSnap.exists()) {
          studentData = docSnap.data().studentData;
        } else {
          studentData = generateInitialData();
          save();
        }
        renderTable();
      });
    }

    const monthSelect = document.getElementById("month-select");
    const weekSelect = document.getElementById("week-select");
    const tableBody = document.getElementById("student-table-body");

    function populateSelectors() {
      months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m; opt.textContent = m;
        monthSelect.appendChild(opt);
      });
      weeks.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w; opt.textContent = w;
        weekSelect.appendChild(opt);
      });
      monthSelect.value = months[0];
      weekSelect.value = weeks[0];
      monthSelect.addEventListener("change", renderTable);
      weekSelect.addEventListener("change", renderTable);
    }

    function renderTable() {
      if (!monthSelect.value || !weekSelect.value) return;
      tableBody.innerHTML = "";
      studentList.forEach((name, idx) => {
        const data = studentData[name]?.[monthSelect.value]?.[weekSelect.value] || {};
        const ranking = getRanking(data.score);
        const row = document.createElement("tr");
        row.className = idx % 2 === 0 ? "bg-white" : "bg-gray-50";
        row.innerHTML = `
          <td class="px-4 py-2">${name}</td>
          <td class="px-2 py-2 text-center">
            <input type="number" value="${data.score ?? ""}" 
              onchange="updateData('${name}', 'score', this.value)" 
              class="w-20 border rounded px-2 py-1 text-center font-semibold">
          </td>
          <td class="px-2 py-2 text-center">
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${ranking === 'Xuáº¥t sáº¯c' ? 'bg-green-100 text-green-700' :
              ranking === 'Tá»‘t' ? 'bg-blue-100 text-blue-700' :
              ranking === 'KhÃ¡' ? 'bg-yellow-100 text-yellow-700' :
              ranking === 'Äáº¡t' ? 'bg-orange-100 text-orange-700' :
              'bg-gray-100 text-gray-500'}">${ranking}</span>
          </td>
          <td class="px-4 py-2">
            <textarea onchange="updateData('${name}', 'advantages', this.value)" 
              class="w-full border rounded px-2 py-1 text-green-700">${data.advantages ?? ""}</textarea>
          </td>
          <td class="px-4 py-2">
            <textarea onchange="updateData('${name}', 'issues', this.value)" 
              class="w-full border rounded px-2 py-1 text-pink-600">${data.issues ?? ""}</textarea>
          </td>`;
        tableBody.appendChild(row);
      });
    }

    // Auto-save nhanh (debounce 300ms)
    let saveTimeout;
    window.updateData = (studentName, field, value) => {
      const m = monthSelect.value;
      const w = weekSelect.value;
      if (!studentData[studentName]) studentData[studentName] = {};
      if (!studentData[studentName][m]) studentData[studentName][m] = {};
      if (!studentData[studentName][m][w]) studentData[studentName][m][w] = {};
      if (field === "score") value = value === "" ? null : Number(value);
      studentData[studentName][m][w][field] = value;
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => save(), 300);
      renderTable();
    };

    window.exportExcel = async (type) => {
      const m = monthSelect.value, w = weekSelect.value;
      const dataToExport = [];
      const header = ["STT", "Há» vÃ  tÃªn", "Äiá»ƒm", "Xáº¿p loáº¡i", "Æ¯u Ä‘iá»ƒm", "Cáº§n cá»‘ gáº¯ng"];
      if (type === "month") header.splice(2, 0, "Tuáº§n");
      dataToExport.push(header);
      let stt = 1;
      for (const name of studentList) {
        if (type === "week") {
          const d = studentData[name][m][w];
          if (d) dataToExport.push([stt++, name, d.score, getRanking(d.score), d.advantages, d.issues]);
        } else {
          for (const wk of weeks) {
            const d = studentData[name][m][wk];
            if (d) dataToExport.push([stt++, name, wk, d.score, getRanking(d.score), d.advantages, d.issues]);
          }
        }
      }
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ThiDua");
      XLSX.writeFile(wb, `ThiDua_${m.replace(" ", "_")}_${type}.xlsx`);
    };

    document.addEventListener("DOMContentLoaded", () => {
      populateSelectors();
      listenForDataChanges();
    });
  </script>
</body>
</html>
