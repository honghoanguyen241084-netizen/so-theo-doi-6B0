<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S·ªï Theo D√µi Thi ƒêua - L·ªõp 6B0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="p-6 bg-gradient-to-r from-pink-50 via-purple-50 to-blue-50 min-h-screen">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-extrabold text-indigo-700">üìò S·ªï Theo D√µi Thi ƒêua (L·ªõp 6B0)</h1>
    <p class="text-gray-600 mt-2">NƒÉm h·ªçc 2024 - 2025</p>
  </div>

  <!-- Controls -->
  <div class="flex flex-wrap gap-4 justify-center mb-6">
    <select id="month-select" class="border p-2 rounded-lg shadow bg-white"></select>
    <select id="week-select" class="border p-2 rounded-lg shadow bg-white"></select>
    <button onclick="exportExcel('week')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow">Xu·∫•t Excel (Tu·∫ßn)</button>
    <button onclick="exportExcel('month')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">Xu·∫•t Excel (Th√°ng)</button>
  </div>

  <!-- Student Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white border rounded-xl shadow-lg" id="student-table">
      <thead class="bg-indigo-100 text-indigo-800">
        <tr>
          <th class="p-2">H·ªçc sinh</th>
          <th class="p-2 w-28">ƒêi·ªÉm</th>
          <th class="p-2 w-32">X·∫øp lo·∫°i</th>
          <th class="p-2 w-64">∆Øu ƒëi·ªÉm</th>
          <th class="p-2 w-64">C·∫ßn c·ªë g·∫Øng</th>
        </tr>
      </thead>
      <tbody id="student-table-body"></tbody>
    </table>
  </div>

  <!-- Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // üîë Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    const months = ["Th√°ng 9","Th√°ng 10","Th√°ng 11","Th√°ng 12","Th√°ng 1","Th√°ng 2","Th√°ng 3","Th√°ng 4","Th√°ng 5"];
    const weeks = ["Tu·∫ßn 1","Tu·∫ßn 2","Tu·∫ßn 3","Tu·∫ßn 4","Tu·∫ßn 5"];

    // ‚úÖ Danh s√°ch 57 h·ªçc sinh chu·∫©n t·ª´ Excel
    const studentList = [
      { name: "Nguy·ªÖn ƒê·∫∑ng Minh An", gender: "N·ªØ" }, { name: "Cung ƒê·ª©c Anh", gender: "Nam" }, { name: "Tr·∫ßn Qu·ª≥nh Anh", gender: "N·ªØ" },
      { name: "Nguy·ªÖn Di·ªáp Anh", gender: "N·ªØ" }, { name: "Ho√†ng Mai Anh", gender: "N·ªØ" }, { name: "Nguy·ªÖn Huy B·∫£o Anh", gender: "Nam" },
      { name: "Nguy·ªÖn Gia B·∫£o", gender: "Nam" }, { name: "Tr·ªãnh Quang B·∫£o", gender: "Nam" }, { name: "L·∫°i Th·∫£o Chi", gender: "N·ªØ" },
      { name: "Ph·∫°m Lam Chi", gender: "N·ªØ" }, { name: "Nguy·ªÖn Kh√°nh Chi", gender: "N·ªØ" }, { name: "Nguy·ªÖn ƒê·ªó Minh Ch√≠", gender: "Nam" },
      { name: "Ph·∫°m Kh∆∞∆°ng Duy", gender: "Nam" }, { name: "Tr·∫ßn Nguy√™n Duy", gender: "Nam" }, { name: "ƒê·ªó Qu·ªëc ƒê·∫°t", gender: "Nam" },
      { name: "L√™ Ti·∫øn ƒê·∫°t", gender: "Nam" }, { name: "Qu√°ch Trung ƒê·ª©c", gender: "Nam" }, { name: "Ph·∫°m Minh ƒê·ª©c", gender: "Nam" },
      { name: "L·∫°i Ti·∫øn ƒê·ª©c", gender: "Nam" }, { name: "Tr·∫ßn Ng·ªçc H√¢n", gender: "N·ªØ" }, { name: "Cao Ho√†ng", gender: "Nam" },
      { name: "Cung ƒê·ª©c Huy", gender: "Nam" }, { name: "Nguy·ªÖn Minh Khu√™", gender: "N·ªØ" }, { name: "Ho√†ng Mi Lan", gender: "N·ªØ" },
      { name: "V≈© My Lan", gender: "N·ªØ" }, { name: "ƒê√†m Gia Linh", gender: "N·ªØ" }, { name: "L√™ Th·∫£o Linh", gender: "N·ªØ" },
      { name: "ƒê·∫∑ng Th√†nh Minh", gender: "Nam" }, { name: "V∆∞∆°ng Quang Minh", gender: "Nam" }, { name: "V≈© Tr·∫ßn Ti·∫øn Minh", gender: "Nam" },
      { name: "ƒê·∫ßu ƒê·∫°i Minh", gender: "Nam" }, { name: "ƒê·∫∑ng Gia Minh", gender: "Nam" }, { name: "Ng√¥ Ho√†ng My", gender: "N·ªØ" },
      { name: "ƒê·∫∑ng Kim Ng√¢n", gender: "N·ªØ" }, { name: "Nguy·ªÖn Kh√°nh Ng·ªçc", gender: "N·ªØ" }, { name: "B√πi B·∫£o Nguy√™n", gender: "Nam" },
      { name: "L√Ω Ho√†ng Minh Nh·∫≠t", gender: "Nam" }, { name: "Ng√¥ H·∫£i Minh", gender: "Nam" }, { name: "D∆∞∆°ng Y·∫øn Nhi", gender: "N·ªØ" },
      { name: "V≈© Kh√°nh Nhi", gender: "N·ªØ" }, { name: "Tr·ªãnh Nam Phong", gender: "Nam" }, { name: "Nguy·ªÖn H√† Ph∆∞∆°ng", gender: "N·ªØ" },
      { name: "D∆∞∆°ng ƒê·∫°i Quang", gender: "Nam" }, { name: "Mai Ti·∫øn Th√†nh", gender: "Nam" }, { name: "Tr·∫ßn Ng·ªçc Th·∫£o", gender: "N·ªØ" },
      { name: "ƒê·∫∑ng Anh Th∆∞", gender: "N·ªØ" }, { name: "Nguy·ªÖn Quang Thi·ªán", gender: "Nam" }, { name: "Nguy·ªÖn ƒê√¨nh Thi", gender: "Nam" },
      { name: "Tr·∫ßn Ph∆∞∆°ng Th·∫£o", gender: "N·ªØ" }, { name: "Tr·ªãnh Ng·ªçc Minh Trang", gender: "N·ªØ" }, { name: "Nguy·ªÖn B·∫£o Tr√¢m", gender: "N·ªØ" },
      { name: "Nguy√™ÃÉn ƒê∆∞ÃÅc TriÃÅ", gender: "Nam" }, { name: "Tr·∫ßn Trung", gender: "Nam" }, { name: "Tr·∫ßn Quang Vinh", gender: "Nam" },
      { name: "L∆∞∆°ng Uy√™n B·∫£o Tr√¢n", gender: "N·ªØ" }, { name: "Nguy·ªÖn Quang Vinh", gender: "Nam" }
    ];

    let studentData = {};

    function populateSelectors(){
      const monthSelect=document.getElementById("month-select");
      const weekSelect=document.getElementById("week-select");
      months.forEach(m=>{let o=document.createElement("option");o.value=m;o.textContent=m;monthSelect.appendChild(o);});
      weeks.forEach(w=>{let o=document.createElement("option");o.value=w;o.textContent=w;weekSelect.appendChild(o);});
      monthSelect.value=months[0]; weekSelect.value=weeks[0];
      monthSelect.onchange=renderTable; weekSelect.onchange=renderTable;
    }

    function getRank(score){
      if(score===null||score==="") return {text:"Ch∆∞a c√≥",color:"bg-gray-200 text-gray-600"};
      if(score>=87) return {text:"Xu·∫•t s·∫Øc",color:"bg-green-200 text-green-800"};
      if(score>=80) return {text:"T·ªët",color:"bg-blue-200 text-blue-800"};
      if(score>=65) return {text:"Kh√°",color:"bg-yellow-200 text-yellow-800"};
      if(score>=50) return {text:"ƒê·∫°t",color:"bg-orange-200 text-orange-800"};
      return {text:"Ch∆∞a ƒë·∫°t",color:"bg-red-200 text-red-800"};
    }

    function renderTable(){
      const tbody=document.getElementById("student-table-body");
      tbody.innerHTML="";
      const m=document.getElementById("month-select").value;
      const w=document.getElementById("week-select").value;

      studentList.forEach((s)=>{
        if(!studentData[s.name]) studentData[s.name]={};
        if(!studentData[s.name][m]) studentData[s.name][m]={};
        if(!studentData[s.name][m][w]) studentData[s.name][m][w]={score:null,advantages:"",issues:""};

        const d=studentData[s.name][m][w];
        const rank=getRank(d.score);
        const tr=document.createElement("tr");
        tr.className="hover:bg-indigo-50";
        tr.innerHTML=`
          <td class="border p-2 bg-slate-50">
            <input type="text" value="${s.name}" class="border p-1 w-full rounded"
              onchange="updateName('${s.name}',this.value)">
          </td>
          <td class="border p-2 text-center">
            <input type="number" value="${d.score??''}" class="border p-1 w-24 text-center rounded font-semibold"
              onchange="updateData('${s.name}','score',this.value)">
          </td>
          <td class="border p-2 text-center">
            <span class="px-3 py-1 rounded-full text-sm ${rank.color}">${rank.text}</span>
          </td>
          <td class="border p-2 bg-green-50">
            <textarea class="border p-1 w-full rounded" onchange="updateData('${s.name}','advantages',this.value)">${d.advantages}</textarea>
          </td>
          <td class="border p-2 bg-pink-50">
            <textarea class="border p-1 w-full rounded" onchange="updateData('${s.name}','issues',this.value)">${d.issues}</textarea>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.updateData=(studentName,field,value)=>{
      const m=document.getElementById("month-select").value;
      const w=document.getElementById("week-select").value;
      if(field==="score") value=value===""?null:Number(value);
      studentData[studentName][m][w][field]=value;
      save();
      renderTable();
    };

    window.updateName=(oldName,newName)=>{
      if(!newName.trim()) return;
      studentData[newName]=studentData[oldName];
      delete studentData[oldName];
      save();
      renderTable();
    };

    async function save(){
      await setDoc(dataDocRef,{studentData},{merge:true});
    }

    function listen(){
      onSnapshot(dataDocRef,(snap)=>{
        if(snap.exists()){ studentData=snap.data().studentData||{}; renderTable(); }
        else { studentData={}; renderTable(); }
      });
    }

    window.exportExcel=(type)=>{
      const m=document.getElementById("month-select").value;
      const w=document.getElementById("week-select").value;
      const dataToExport=[];
      const header=["STT","H·ªç v√† T√™n","ƒêi·ªÉm","X·∫øp lo·∫°i","∆Øu ƒëi·ªÉm","C·∫ßn c·ªë g·∫Øng"];
      if(type==="month") header.splice(2,0,"Tu·∫ßn");
      dataToExport.push(header);
      let stt=1;
      for(const s of studentList){
        if(studentData[s.name]){
          if(type==="week"){
            const d=studentData[s.name][m][w];
            if(d){ dataToExport.push([stt++,s.name,d.score??"",getRank(d.score).text,d.advantages,d.issues]); }
          }else{
            for(const wk of weeks){
              const d=studentData[s.name][m][wk];
              if(d){ dataToExport.push([stt++,s.name,wk,d.score??"",getRank(d.score).text,d.advantages,d.issues]); }
            }
          }
        }
      }
      const ws=XLSX.utils.aoa_to_sheet(dataToExport);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"ThiDua");
      XLSX.writeFile(wb,`ThiDua_${m.replace(" ","_")}_${type}.xlsx`);
    };

    document.addEventListener("DOMContentLoaded",()=>{ populateSelectors(); listen(); });
  </script>
</body>
</html>
