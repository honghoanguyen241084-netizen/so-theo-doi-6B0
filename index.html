<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sổ Theo Dõi Thi Đua - Lớp 6B0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
    }

    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4f46e5;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {transform: rotate(0deg)}
      100% {transform: rotate(360deg)}
    }
  </style>
</head>

<body class="p-4 md:p-6">
  <div id="app" class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-2xl shadow-lg p-6 mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold">📘 Sổ Theo Dõi Thi Đua - Lớp 6B0</h1>
      <p class="text-indigo-100 mt-2">Năm học 2024 - 2025</p>
    </div>

    <!-- Controls -->
    <div class="flex flex-wrap gap-3 justify-center mb-6">
      <select id="month-select" class="border p-2 rounded-lg shadow bg-white"></select>
      <select id="week-select" class="border p-2 rounded-lg shadow bg-white"></select>
      <button onclick="save()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg shadow">💾 Lưu dữ liệu</button>
      <button onclick="exportExcel('week')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow">📤 Xuất Excel (Tuần)</button>
      <button onclick="exportExcel('month')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">📤 Xuất Excel (Tháng)</button>
    </div>

    <!-- Student Table -->
    <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-indigo-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Học sinh</th>
            <th class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase">Điểm</th>
            <th class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase">Xếp loại</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">👍 Ưu điểm</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">✏️ Cần cố gắng</th>
          </tr>
        </thead>
        <tbody id="student-table-body" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loading-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
      <div class="loader mx-auto"></div>
      <p id="loading-text" class="mt-3 text-gray-700 font-medium">Đang lưu dữ liệu...</p>
    </div>
  </div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Firebase config của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    // Danh sách học sinh (57 HS + Nguyễn Minh Trí + Nguyễn Quang Huy)
    const studentList = [
      { name: "Nguyễn Đặng Minh An", gender: "Nữ" },
      { name: "Cung Đức Anh", gender: "Nam" },
      { name: "Trần Quỳnh Anh", gender: "Nữ" },
      { name: "Nguyễn Diệp Anh", gender: "Nữ" },
      { name: "Hoàng Mai Anh", gender: "Nữ" },
      { name: "Nguyễn Huy Bảo Anh", gender: "Nam" },
      { name: "Nguyễn Gia Bảo", gender: "Nam" },
      { name: "Trịnh Quang Bảo", gender: "Nam" },
      { name: "Lại Thảo Chi", gender: "Nữ" },
      { name: "Phạm Lam Chi", gender: "Nữ" },
      { name: "Nguyễn Khánh Chi", gender: "Nữ" },
      { name: "Nguyễn Đỗ Minh Chí", gender: "Nam" },
      { name: "Phạm Khương Duy", gender: "Nam" },
      { name: "Trần Nguyên Duy", gender: "Nam" },
      { name: "Đỗ Quốc Đạt", gender: "Nam" },
      { name: "Lê Tiến Đạt", gender: "Nam" },
      { name: "Quách Trung Đức", gender: "Nam" },
      { name: "Phạm Minh Đức", gender: "Nam" },
      { name: "Lại Tiến Đức", gender: "Nam" },
      { name: "Trần Ngọc Hân", gender: "Nữ" },
      { name: "Cao Hoàng", gender: "Nam" },
      { name: "Cung Đức Huy", gender: "Nam" },
      { name: "Nguyễn Minh Khuê", gender: "Nữ" },
      { name: "Hoàng Mi Lan", gender: "Nữ" },
      { name: "Vũ My Lan", gender: "Nữ" },
      { name: "Đàm Gia Linh", gender: "Nữ" },
      { name: "Lê Thảo Linh", gender: "Nữ" },
      { name: "Đặng Thành Minh", gender: "Nam" },
      { name: "Vương Quang Minh", gender: "Nam" },
      { name: "Vũ Trần Tiến Minh", gender: "Nam" },
      { name: "Đầu Đại Minh", gender: "Nam" },
      { name: "Đặng Gia Minh", gender: "Nam" },
      { name: "Ngô Hoàng My", gender: "Nữ" },
      { name: "Đặng Kim Ngân", gender: "Nữ" },
      { name: "Nguyễn Khánh Ngọc", gender: "Nữ" },
      { name: "Bùi Bảo Nguyên", gender: "Nam" },
      { name: "Lý Hoàng Minh Nhật", gender: "Nam" },
      { name: "Ngô Hải Minh", gender: "Nam" },
      { name: "Dương Yến Nhi", gender: "Nữ" },
      { name: "Vũ Khánh Nhi", gender: "Nữ" },
      { name: "Trịnh Nam Phong", gender: "Nam" },
      { name: "Nguyễn Hà Phương", gender: "Nữ" },
      { name: "Dương Đại Quang", gender: "Nam" },
      { name: "Mai Tiến Thành", gender: "Nam" },
      { name: "Trần Ngọc Thảo", gender: "Nữ" },
      { name: "Đặng Anh Thư", gender: "Nữ" },
      { name: "Nguyễn Quang Thiện", gender: "Nam" },
      { name: "Nguyễn Đình Thi", gender: "Nam" },
      { name: "Trần Phương Thảo", gender: "Nữ" },
      { name: "Trịnh Ngọc Minh Trang", gender: "Nữ" },
      { name: "Nguyễn Bảo Trâm", gender: "Nữ" },
      { name: "Nguyễn Đức Trí", gender: "Nam" },
      { name: "Nguyễn Minh Trí", gender: "Nam" },
      { name: "Nguyễn Quang Huy", gender: "Nam" },
      { name: "Trần Trung", gender: "Nam" },
      { name: "Trần Quang Vinh", gender: "Nam" },
      { name: "Lương Uyên Bảo Trân", gender: "Nữ" },
      { name: "Nguyễn Quang Vinh", gender: "Nam" }
    ];

    const months = Array.from({ length: 9 }, (_, i) => `Tháng ${i + 9 > 12 ? i + 9 - 12 : i + 9}`);
    const weeks = ["Tuần 1", "Tuần 2", "Tuần 3", "Tuần 4", "Tuần 5"];
    let studentData = {};

    function generateInitialData() {
      const initial = {};
      studentList.forEach(s => {
        initial[s.name] = {};
        months.forEach(m => {
          initial[s.name][m] = {};
          weeks.forEach(w => {
            initial[s.name][m][w] = { score: null, advantages: "", issues: "" };
          });
        });
      });
      return initial;
    }

    function getRanking(score) {
      if (score === null || score === "") return "Chưa có";
      if (score >= 87) return "Xuất sắc";
      if (score >= 80) return "Tốt";
      if (score >= 65) return "Khá";
      if (score >= 50) return "Đạt";
      return "Chưa đạt";
    }

    async function save() {
      document.getElementById("loading-text").textContent = "Đang lưu dữ liệu...";
      document.getElementById("loading-modal").classList.remove("hidden");
      document.getElementById("loading-modal").classList.add("flex");
      await setDoc(dataDocRef, { studentData }, { merge: true });
      setTimeout(() => {
        document.getElementById("loading-modal").classList.add("hidden");
        document.getElementById("loading-modal").classList.remove("flex");
        alert("✅ Dữ liệu đã được lưu thành công!");
      }, 800);
    }

    function listenForDataChanges() {
      onSnapshot(dataDocRef, (docSnap) => {
        if (docSnap.exists()) {
          studentData = docSnap.data().studentData;
        } else {
          studentData = generateInitialData();
          save();
        }
        renderTable();
      });
    }

    const monthSelect = document.getElementById("month-select");
    const weekSelect = document.getElementById("week-select");
    const tableBody = document.getElementById("student-table-body");

    function populateSelectors() {
      months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m; opt.textContent = m;
        monthSelect.appendChild(opt);
      });
      weeks.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w; opt.textContent = w;
        weekSelect.appendChild(opt);
      });
      monthSelect.addEventListener("change", renderTable);
      weekSelect.addEventListener("change", renderTable);
      monthSelect.value = months[0];
      weekSelect.value = weeks[0];
    }

    function renderTable() {
      if (!monthSelect.value || !weekSelect.value) return;
      tableBody.innerHTML = "";
      studentList.forEach((s, idx) => {
        const data = studentData[s.name]?.[monthSelect.value]?.[weekSelect.value] || {};
        const ranking = getRanking(data.score);
        const row = document.createElement("tr");
        row.className = idx % 2 === 0 ? "bg-white" : "bg-gray-50";
        row.innerHTML = `
          <td class="px-4 py-2">
            <input type="text" value="${s.name}" onchange="updateData('${s.name}', 'name', this.value)" 
              class="w-full border rounded px-2 py-1 text-gray-700 font-medium">
          </td>
          <td class="px-2 py-2 text-center">
            <input type="number" value="${data.score ?? ""}" 
              onchange="updateData('${s.name}', 'score', this.value)" 
              class="w-20 border rounded px-2 py-1 text-center font-semibold">
          </td>
          <td class="px-2 py-2 text-center">
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${ranking === 'Xuất sắc' ? 'bg-green-100 text-green-700' :
              ranking === 'Tốt' ? 'bg-blue-100 text-blue-700' :
              ranking === 'Khá' ? 'bg-yellow-100 text-yellow-700' :
              ranking === 'Đạt' ? 'bg-orange-100 text-orange-700' :
              'bg-gray-100 text-gray-500'}">${ranking}</span>
          </td>
          <td class="px-4 py-2">
            <textarea onchange="updateData('${s.name}', 'advantages', this.value)" 
              class="w-full border rounded px-2 py-1 text-green-700">${data.advantages ?? ""}</textarea>
          </td>
          <td class="px-4 py-2">
            <textarea onchange="updateData('${s.name}', 'issues', this.value)" 
              class="w-full border rounded px-2 py-1 text-pink-600">${data.issues ?? ""}</textarea>
          </td>`;
        tableBody.appendChild(row);
      });
    }

    window.updateData = (studentName, field, value) => {
      const m = monthSelect.value;
      const w = weekSelect.value;
      if (!studentData[studentName]) studentData[studentName] = {};
      if (!studentData[studentName][m]) studentData[studentName][m] = {};
      if (!studentData[studentName][m][w]) studentData[studentName][m][w] = {};
      if (field === "score") value = value === "" ? null : Number(value);
      if (field === "name") {
        studentData[value] = studentData[studentName];
        delete studentData[studentName];
      } else {
        studentData[studentName][m][w][field] = value;
      }
      save();
      renderTable();
    };

    window.exportExcel = async (type) => {
      const m = monthSelect.value, w = weekSelect.value;
      const dataToExport = [];
      const header = ["STT", "Họ và tên", "Điểm", "Xếp loại", "Ưu điểm", "Cần cố gắng"];
      if (type === "month") header.splice(2, 0, "Tuần");
      dataToExport.push(header);
      let stt = 1;
      for (const s of studentList) {
        if (type === "week") {
          const d = studentData[s.name][m][w];
          if (d) dataToExport.push([stt++, s.name, d.score, getRanking(d.score), d.advantages, d.issues]);
        } else {
          for (const wk of weeks) {
            const d = studentData[s.name][m][wk];
            if (d) dataToExport.push([stt++, s.name, wk, d.score, getRanking(d.score), d.advantages, d.issues]);
          }
        }
      }
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ThiDua");
      XLSX.writeFile(wb, `ThiDua_${m.replace(" ", "_")}_${type}.xlsx`);
    };

    document.addEventListener("DOMContentLoaded", () => {
      populateSelectors();
      listenForDataChanges();
    });
  </script>
</body>
</html>
