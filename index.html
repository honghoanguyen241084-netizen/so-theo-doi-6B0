<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sá»• Theo DÃµi Thi Äua - Lá»›p 6B0</title>

  <!-- Tailwind & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- XLSX for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body{ font-family:'Inter',sans-serif; background:#f9fafb; }
    .award-card{ background:#fff; border-radius:12px; padding:1rem; box-shadow:0 4px 6px rgba(0,0,0,.08); transition:transform .2s }
    .award-card:hover{ transform:translateY(-3px) }
    textarea{ min-height:48px }
  </style>
</head>
<body class="p-4 md:p-6">

  <!-- Header -->
  <div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl shadow-lg p-6 mb-6">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold">ğŸ“˜ Sá»• Theo DÃµi Thi Äua - Lá»›p 6B0</h1>
        <p class="text-indigo-100 mt-1 text-lg">NÄƒm há»c 2025 - 2026</p>
      </div>
      <div class="flex gap-2">
        <button onclick="exportExcel('week')" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg shadow">ğŸ“¥ Xuáº¥t Excel (Tuáº§n)</button>
        <button onclick="exportExcel('month')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">ğŸ“¥ Xuáº¥t Excel (ThÃ¡ng)</button>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="flex flex-wrap items-center gap-3 mb-6">
    <select id="month-select" class="p-2 rounded border border-gray-300 bg-white"></select>
    <select id="week-select" class="p-2 rounded border border-gray-300 bg-white"></select>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full">
      <thead class="bg-indigo-50">
        <tr>
          <th class="px-4 py-2 text-left font-bold">Há»c sinh</th>
          <th class="px-2 py-2 text-center font-bold w-24">Äiá»ƒm</th>
          <th class="px-2 py-2 text-center font-bold w-32">Xáº¿p loáº¡i</th>
          <th class="px-4 py-2 font-bold">ğŸ‘ Æ¯u Ä‘iá»ƒm</th>
          <th class="px-4 py-2 font-bold">âœï¸ Cáº§n cá»‘ gáº¯ng</th>
          <th class="px-2 py-2 text-center font-bold w-24">âœ¨ CÃ´ Hoa</th>
        </tr>
      </thead>
      <tbody id="student-table-body" class="divide-y divide-gray-100"></tbody>
    </table>
  </div>

  <!-- Awards -->
  <div class="mt-10 text-center">
    <button onclick="generateAwards()" class="bg-gradient-to-r from-amber-400 to-orange-500 text-white px-6 py-3 rounded-lg font-bold shadow hover:scale-105">
      ğŸ† Tá»•ng káº¿t & Danh hiá»‡u tuáº§n
    </button>
    <div id="awards-container" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
  </div>

  <!-- Firebase App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // === Firebase config (Ä‘Ãºng theo project cá»§a cÃ´) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    // === Danh sÃ¡ch há»c sinh ===
    const studentList = [
      "Nguyá»…n Äáº·ng Minh An","Cung Äá»©c Anh","Tráº§n Quá»³nh Anh","Nguyá»…n Diá»‡p Anh","HoÃ ng Mai Anh","Nguyá»…n Huy Báº£o Anh",
      "Nguyá»…n Gia Báº£o","Trá»‹nh Quang Báº£o","Láº¡i Tháº£o Chi","Pháº¡m Lam Chi","Nguyá»…n KhÃ¡nh Chi","Nguyá»…n Äá»— Minh ChÃ­",
      "Pháº¡m KhÆ°Æ¡ng Duy","Tráº§n NguyÃªn Duy","Äá»— Quá»‘c Äáº¡t","LÃª Tiáº¿n Äáº¡t","QuÃ¡ch Trung Äá»©c","Pháº¡m Minh Äá»©c",
      "Láº¡i Tiáº¿n Äá»©c","Tráº§n Ngá»c HÃ¢n","Cao HoÃ ng","Cung Äá»©c Huy","Nguyá»…n Minh KhuÃª","HoÃ ng Mi Lan",
      "VÅ© My Lan","ÄÃ m Gia Linh","LÃª Tháº£o Linh","Äáº·ng ThÃ nh Minh","VÆ°Æ¡ng Quang Minh","VÅ© Tráº§n Tiáº¿n Minh",
      "Äáº§u Äáº¡i Minh","Äáº·ng Gia Minh","NgÃ´ HoÃ ng My","Äáº·ng Kim NgÃ¢n","Nguyá»…n KhÃ¡nh Ngá»c","BÃ¹i Báº£o NguyÃªn",
      "LÃ½ HoÃ ng Minh Nháº­t","NgÃ´ Háº£i Minh","DÆ°Æ¡ng Yáº¿n Nhi","VÅ© KhÃ¡nh Nhi","Trá»‹nh Nam Phong","Nguyá»…n HÃ  PhÆ°Æ¡ng",
      "DÆ°Æ¡ng Äáº¡i Quang","Mai Tiáº¿n ThÃ nh","Tráº§n Ngá»c Tháº£o","Äáº·ng Anh ThÆ°","Nguyá»…n Quang Thiá»‡n","Nguyá»…n ÄÃ¬nh Thi",
      "Tráº§n PhÆ°Æ¡ng Tháº£o","Trá»‹nh Ngá»c Minh Trang","Nguyá»…n Báº£o TrÃ¢m","Nguyá»…n Äá»©c TrÃ­","Tráº§n Trung","Tráº§n Quang Vinh",
      "LÆ°Æ¡ng UyÃªn Báº£o TrÃ¢n","Nguyá»…n Quang Vinh","Nguyá»…n Minh TrÃ­","Nguyá»…n Quang Huy"
    ];

    // ThÃ¡ng há»c (9â†’5)
    const months = ["ThÃ¡ng 9","ThÃ¡ng 10","ThÃ¡ng 11","ThÃ¡ng 12","ThÃ¡ng 1","ThÃ¡ng 2","ThÃ¡ng 3","ThÃ¡ng 4","ThÃ¡ng 5"];
    const weeks  = ["Tuáº§n 1","Tuáº§n 2","Tuáº§n 3","Tuáº§n 4","Tuáº§n 5"];

    // Cache cá»¥c bá»™
    let studentData = {};

    // === Helpers ===
    function getRanking(score){
      if (score === null || score === "") return {rank:"ChÆ°a cÃ³", color:"bg-gray-100 text-gray-600"};
      if (score >= 87) return {rank:"Xuáº¥t sáº¯c", color:"bg-green-100 text-green-800"};
      if (score >= 80) return {rank:"Tá»‘t",      color:"bg-blue-100 text-blue-800"};
      if (score >= 65) return {rank:"KhÃ¡",      color:"bg-yellow-100 text-yellow-800"};
      if (score >= 50) return {rank:"Äáº¡t",      color:"bg-orange-100 text-orange-800"};
      return {rank:"ChÆ°a Ä‘áº¡t", color:"bg-red-100 text-red-800"};
    }

    function generateAdvice(adv, iss){
      let s = "";
      if (adv) s += `CÃ´ khen con ${adv.trim()}. `;
      if (iss) s += `NhÆ°ng cáº§n chÃº Ã½: ${iss.trim()}. `;
      if (!adv && !iss) s = "CÃ´ mong con ná»— lá»±c hÆ¡n trong tuáº§n tá»›i nhÃ©.";
      return s.trim();
    }

    // === DOM ===
    const monthSelect = document.getElementById("month-select");
    const weekSelect  = document.getElementById("week-select");
    const tableBody   = document.getElementById("student-table-body");
    const awardsContainer = document.getElementById("awards-container");

    // Populate selectors
    months.forEach(m => { const o = document.createElement("option"); o.value=m; o.textContent=m; monthSelect.appendChild(o); });
    weeks.forEach(w  => { const o = document.createElement("option"); o.value=w; o.textContent=w; weekSelect.appendChild(o); });

    // Default chá»n theo thÃ¡ng hiá»‡n táº¡i náº¿u náº±m trong khoáº£ng
    (function setDefaultSelectors(){
      const now = new Date();
      const mIdx = now.getMonth()+1; // 1..12
      const label = `ThÃ¡ng ${mIdx}`;
      monthSelect.value = months.includes(label) ? label : "ThÃ¡ng 9";
      weekSelect.value  = "Tuáº§n 1";
    })();

    monthSelect.addEventListener("change", renderTable);
    weekSelect.addEventListener("change", renderTable);

    // === Render báº£ng ===
    function renderTable(){
      const m = monthSelect.value;
      const w = weekSelect.value;
      tableBody.innerHTML = "";

      studentList.forEach((name, idx) => {
        // Ä‘áº£m báº£o tá»“n táº¡i khung dá»¯ liá»‡u
        if (!studentData[name]) studentData[name] = {};
        if (!studentData[name][m]) studentData[name][m] = {};
        if (!studentData[name][m][w]) studentData[name][m][w] = { score:null, adv:"", iss:"", advice:"" };

        const d = studentData[name][m][w];
        const rk = getRanking(d.score);

        const tr = document.createElement("tr");
        tr.className = idx % 2 === 0 ? "bg-white" : "bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">
            <div class="flex items-center gap-2">
              <span>${name}</span>
              <button class="text-xs px-2 py-1 rounded bg-indigo-50 text-indigo-700 hover:bg-indigo-100"
                title="Sá»­a tÃªn" onclick="renameStudent('${name}')">âœï¸</button>
            </div>
          </td>
          <td class="px-2 py-2 text-center">
            <input type="number" value="${d.score ?? ""}" class="w-20 p-1 border rounded text-center font-semibold"
              onchange="updateData('${name}','score',this.value)" />
          </td>
          <td class="px-2 py-2 text-center">
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${rk.color}">${rk.rank}</span>
          </td>
          <td class="px-4 py-2">
            <textarea class="w-full border rounded px-2 py-1 text-green-800"
              onchange="updateData('${name}','adv',this.value)">${d.adv ?? ""}</textarea>
          </td>
          <td class="px-4 py-2">
            <textarea class="w-full border rounded px-2 py-1 text-pink-600"
              onchange="updateData('${name}','iss',this.value)">${d.iss ?? ""}</textarea>
          </td>
          <td class="px-2 py-2 text-center">
            <button class="text-2xl hover:scale-125 transition" title="Xin nháº­n xÃ©t tá»« CÃ´ Hoa"
              onclick="getAdvice('${name}')">âœ¨</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // === LÆ°u nhanh chá»‰ field thay Ä‘á»•i (trÃ¡nh ghi Ä‘Ã¨) ===
    // dÃ¹ng path update Ä‘á»ƒ nhiá»u ngÆ°á»i nháº­p cÃ¹ng lÃºc khÃ´ng chÃ¨n nhau
    let saveTimer;
    window.updateData = (name, field, value) => {
      const m = monthSelect.value, w = weekSelect.value;
      if (field === "score") value = value === "" ? null : Number(value);

      // cáº­p nháº­t cache cá»¥c bá»™
      if (!studentData[name]) studentData[name] = {};
      if (!studentData[name][m]) studentData[name][m] = {};
      if (!studentData[name][m][w]) studentData[name][m][w] = { score:null, adv:"", iss:"", advice:"" };
      studentData[name][m][w][field] = value;

      // cáº­p nháº­t Firestore theo Ä‘Æ°á»ng dáº«n field cá»¥ thá»ƒ
      const path = `studentData.${name}.${m}.${w}.${field}`;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        setDoc(dataDocRef, { [path]: value }, { merge: true });
      }, 250);

      // re-render Ä‘á»ƒ badge xáº¿p loáº¡i cáº­p nháº­t ngay
      renderTable();
    };

    // === Xin nháº­n xÃ©t CÃ´ Hoa (AI cá»¥c bá»™) ===
    window.getAdvice = (name) => {
      const m = monthSelect.value, w = weekSelect.value;
      const d = studentData[name]?.[m]?.[w] || { adv:"", iss:"" };
      const advice = generateAdvice(d.adv, d.iss);

      // lÆ°u chá»‰ field advice
      const path = `studentData.${name}.${m}.${w}.advice`;
      setDoc(dataDocRef, { [path]: advice }, { merge: true });

      alert(`Nháº­n xÃ©t cá»§a CÃ´ Hoa:\n\n${advice}`);
    };

    // === Äá»•i tÃªn há»c sinh (di trÃº dá»¯ liá»‡u an toÃ n) ===
    window.renameStudent = async (oldName) => {
      const newName = prompt("Nháº­p tÃªn má»›i cho há»c sinh:", oldName)?.trim();
      if (!newName || newName === oldName) return;
      if (studentData[newName]) { alert("TÃªn má»›i Ä‘Ã£ tá»“n táº¡i trong danh sÃ¡ch."); return; }

      const oldData = studentData[oldName] || {};
      // ghi báº£n sao sang tÃªn má»›i
      await setDoc(dataDocRef, { ["studentData."+newName]: oldData }, { merge: true });
      // xÃ³a tÃªn cÅ©
      await updateDoc(dataDocRef, { ["studentData."+oldName]: deleteField() });
      // cáº­p nháº­t cache local (Ä‘á»ƒ khÃ´ng chá» snapshot má»›i)
      delete studentData[oldName];
      studentData[newName] = oldData;
      renderTable();
    };

    // === Nghe realtime Firestore â†’ hiá»ƒn thá»‹ ngay khi má»Ÿ trang ===
    onSnapshot(dataDocRef, (snap) => {
      if (snap.exists()) {
        // dá»¯ liá»‡u tá»« server lÃ  nguá»“n chÃ¢n lÃ½
        studentData = snap.data().studentData || {};
      } else {
        studentData = {};
      }
      renderTable();
    });

    // === Xuáº¥t Excel ===
    window.exportExcel = (type) => {
      const m = monthSelect.value, w = weekSelect.value;

      let aoa;
      if (type === "week") {
        aoa = [["STT","Há» vÃ  tÃªn","Äiá»ƒm","Xáº¿p loáº¡i","Æ¯u Ä‘iá»ƒm","Cáº§n cá»‘ gáº¯ng","Nháº­n xÃ©t CÃ´ Hoa"]];
      } else {
        aoa = [["STT","Há» vÃ  tÃªn","Tuáº§n","Äiá»ƒm","Xáº¿p loáº¡i","Æ¯u Ä‘iá»ƒm","Cáº§n cá»‘ gáº¯ng","Nháº­n xÃ©t CÃ´ Hoa"]];
      }

      let stt = 1;
      studentList.forEach((name) => {
        const mData = studentData[name]?.[m] || {};
        if (type === "week") {
          const d = mData[w];
          if (!d) return;
          aoa.push([stt++, name, d.score ?? "", getRanking(d.score).rank, d.adv ?? "", d.iss ?? "", d.advice ?? ""]);
        } else {
          weeks.forEach((wk) => {
            const d = mData[wk];
            if (!d) return;
            aoa.push([stt++, name, wk, d.score ?? "", getRanking(d.score).rank, d.adv ?? "", d.iss ?? "", d.advice ?? ""]);
          });
        }
      });

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ThiDua");
      XLSX.writeFile(wb, `ThiDua_${m.replace(" ","_")}_${type}.xlsx`);
    };

    // === Danh hiá»‡u tuáº§n ===
    window.generateAwards = () => {
      const m = monthSelect.value, w = weekSelect.value;
      const awards = { excellent: [], hardworking: [], progressive: [], disciplined: [] };

      studentList.forEach((name) => {
        const cur = studentData[name]?.[m]?.[w];
        if (!cur) return;

        // tiÃªu chÃ­ cÆ¡ báº£n
        if (cur.score >= 87) awards.excellent.push(name);
        if ((cur.adv || "").toLowerCase().includes("phÃ¡t biá»ƒu") || (cur.adv || "").includes("10"))
          awards.hardworking.push(name);
        if (!cur.iss) awards.disciplined.push(name);

        // tiáº¿n bá»™ so vá»›i tuáº§n trÆ°á»›c (náº¿u cÃ³)
        const wIdx = weeks.indexOf(w);
        if (wIdx > 0) {
          const prev = studentData[name]?.[m]?.[weeks[wIdx - 1]];
          if (prev && cur.score != null && prev.score != null && cur.score > prev.score) {
            awards.progressive.push(`${name} (+${cur.score - prev.score}Ä‘)`);
          }
        }
      });

      awardsContainer.innerHTML = "";
      const box = (title, list, colors) => {
        const div = document.createElement("div");
        div.className = "award-card";
        div.innerHTML = `
          <h3 class="font-bold mb-2">${title}</h3>
          ${list.length ? `<ul class="list-disc list-inside">${list.map(n=>`<li>${n}</li>`).join("")}</ul>`
                         : `<p class="text-gray-400 italic">ChÆ°a cÃ³ há»c sinh nÃ o</p>`}
        `;
        awardsContainer.appendChild(div);
      };

      box("NgÃ´i sao há»c táº­p â­", awards.excellent);
      box("Ong chÄƒm chá»‰ ğŸ", awards.hardworking);
      box("Chiáº¿n binh tiáº¿n bá»™ ğŸš€", awards.progressive);
      box("Hiá»‡p sÄ© ná» náº¿p ğŸ›¡ï¸", awards.disciplined);
    };

    // Láº§n Ä‘áº§u render
    renderTable();
  </script>
</body>
</html>
