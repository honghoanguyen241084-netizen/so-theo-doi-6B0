<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sổ Theo Dõi Thi Đua - Lớp 6B0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f9fafb; }
    textarea { min-height: 48px; }
  </style>
</head>

<body class="p-4 md:p-6">
  <div id="app" class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-2xl shadow-lg p-6 mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold">📘 Sổ Theo Dõi Thi Đua - Lớp 6B0</h1>
      <p class="text-indigo-100 mt-2">Năm học 2024 - 2025</p>
    </div>

    <!-- Controls -->
    <div class="flex flex-wrap gap-3 justify-center mb-6">
      <select id="month-select" class="border p-2 rounded-lg shadow bg-white"></select>
      <select id="week-select" class="border p-2 rounded-lg shadow bg-white"></select>
      <button onclick="exportExcel('week')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow">📤 Xuất Excel (Tuần)</button>
      <button onclick="exportExcel('month')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">📤 Xuất Excel (Tháng)</button>
    </div>

    <!-- Student Table -->
    <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-indigo-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Học sinh</th>
            <th class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase">Điểm</th>
            <th class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase">Xếp loại</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">👍 Ưu điểm</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">✏️ Cần cố gắng</th>
          </tr>
        </thead>
        <tbody id="student-table-body" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    // Danh sách 57 HS (chuẩn từ file) + Nguyễn Minh Trí, Nguyễn Quang Huy
    const studentList = [
      "Nguyễn Đặng Minh An","Cung Đức Anh","Trần Quỳnh Anh","Nguyễn Diệp Anh","Hoàng Mai Anh",
      "Nguyễn Huy Bảo Anh","Nguyễn Gia Bảo","Trịnh Quang Bảo","Lại Thảo Chi","Phạm Lam Chi",
      "Nguyễn Khánh Chi","Nguyễn Đỗ Minh Chí","Phạm Khương Duy","Trần Nguyên Duy","Đỗ Quốc Đạt",
      "Lê Tiến Đạt","Quách Trung Đức","Phạm Minh Đức","Lại Tiến Đức","Trần Ngọc Hân",
      "Cao Hoàng","Cung Đức Huy","Nguyễn Minh Khuê","Hoàng Mi Lan","Vũ My Lan",
      "Đàm Gia Linh","Lê Thảo Linh","Đặng Thành Minh","Vương Quang Minh","Vũ Trần Tiến Minh",
      "Đầu Đại Minh","Đặng Gia Minh","Ngô Hoàng My","Đặng Kim Ngân","Nguyễn Khánh Ngọc",
      "Bùi Bảo Nguyên","Lý Hoàng Minh Nhật","Ngô Hải Minh","Dương Yến Nhi","Vũ Khánh Nhi",
      "Trịnh Nam Phong","Nguyễn Hà Phương","Dương Đại Quang","Mai Tiến Thành","Trần Ngọc Thảo",
      "Đặng Anh Thư","Nguyễn Quang Thiện","Nguyễn Đình Thi","Trần Phương Thảo","Trịnh Ngọc Minh Trang",
      "Nguyễn Bảo Trâm","Nguyễn Đức Trí","Nguyễn Minh Trí","Nguyễn Quang Huy","Trần Trung",
      "Trần Quang Vinh","Lương Uyên Bảo Trân","Nguyễn Quang Vinh"
    ];

    const months = Array.from({ length: 9 }, (_, i) => `Tháng ${i + 9 > 12 ? i + 9 - 12 : i + 9}`);
    const weeks = ["Tuần 1","Tuần 2","Tuần 3","Tuần 4","Tuần 5"];
    let studentData = {};

    function generateInitialData() {
      const initial = {};
      studentList.forEach(n => {
        initial[n] = {};
        months.forEach(m => {
          initial[n][m] = {};
          weeks.forEach(w => {
            initial[n][m][w] = { score: null, advantages: "", issues: "" };
          });
        });
      });
      return initial;
    }

    function getRanking(score) {
      if (score === null || score === "") return "Chưa có";
      if (score >= 87) return "Xuất sắc";
      if (score >= 80) return "Tốt";
      if (score >= 65) return "Khá";
      if (score >= 50) return "Đạt";
      return "Chưa đạt";
    }

    async function save() {
      await setDoc(dataDocRef, { studentData }, { merge: true });
    }

    function listenForDataChanges() {
      onSnapshot(dataDocRef, (docSnap) => {
        if (docSnap.exists()) {
          studentData = docSnap.data().studentData;
        } else {
          studentData = generateInitialData();
          save();
        }
        renderTable();
      });
    }

    const monthSelect = document.getElementById("month-select");
    const weekSelect = document.getElementById("week-select");
    const tableBody = document.getElementById("student-table-body");

    function populateSelectors() {
      months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m; opt.textContent = m;
        monthSelect.appendChild(opt);
      });
      weeks.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w; opt.textContent = w;
        weekSelect.appendChild(opt);
      });
      monthSelect.value = months[0];
      weekSelect.value = weeks[0];
      monthSelect.addEventListener("change", renderTable);
      weekSelect.addEventListener("change", renderTable);
    }

    function renderTable() {
      if (!monthSelect.value || !weekSelect.value) return;
      tableBody.innerHTML = "";
      studentList.forEach((name, idx) => {
        const data = studentData[name]?.[monthSelect.value]?.[weekSelect.value] || {};
        const ranking = getRanking(data.score);
        const row = document.createElement("tr");
        row.className = idx % 2 === 0 ? "bg-white" : "bg-gray-50";
        row.innerHTML = `
          <td class="px-4 py-2">${name}</td>
          <td class="px-2 py-2 text-center">
            <input type="number" value="${data.score ?? ""}" 
              onchange="updateData('${name}', 'score', this.value)" 
              class="w-20 border rounded px-2 py-1 text-center font-semibold">
          </td>
          <td class="px-2 py-2 text-center">
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${ranking === 'Xuất sắc' ? 'bg-green-100 text-green-700' :
              ranking === 'Tốt' ? 'bg-blue-100 text-blue-700' :
              ranking === 'Khá' ? 'bg-yellow-100 text-yellow-700' :
              ranking === 'Đạt' ? 'bg-orange-100 text-orange-700' :
              'bg-gray-100 text-gray-500'}">${ranking}</span>
          </td>
          <td class="px-4 py-2">
            <textarea onchange="updateData('${name}', 'advantages', this.value)" 
              class="w-full border rounded px-2 py-1 text-green-700">${data.advantages ?? ""}</textarea>
          </td>
          <td class="px-4 py-2">
            <textarea onchange="updateData('${name}', 'issues', this.value)" 
              class="w-full border rounded px-2 py-1 text-pink-600">${data.issues ?? ""}</textarea>
          </td>`;
        tableBody.appendChild(row);
      });
    }

    // Auto-save nhanh (debounce 300ms)
    let saveTimeout;
    window.updateData = (studentName, field, value) => {
      const m = monthSelect.value;
      const w = weekSelect.value;
      if (!studentData[studentName]) studentData[studentName] = {};
      if (!studentData[studentName][m]) studentData[studentName][m] = {};
      if (!studentData[studentName][m][w]) studentData[studentName][m][w] = {};
      if (field === "score") value = value === "" ? null : Number(value);
      studentData[studentName][m][w][field] = value;
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => save(), 300);
      renderTable();
    };

    window.exportExcel = async (type) => {
      const m = monthSelect.value, w = weekSelect.value;
      const dataToExport = [];
      const header = ["STT", "Họ và tên", "Điểm", "Xếp loại", "Ưu điểm", "Cần cố gắng"];
      if (type === "month") header.splice(2, 0, "Tuần");
      dataToExport.push(header);
      let stt = 1;
      for (const name of studentList) {
        if (type === "week") {
          const d = studentData[name][m][w];
          if (d) dataToExport.push([stt++, name, d.score, getRanking(d.score), d.advantages, d.issues]);
        } else {
          for (const wk of weeks) {
            const d = studentData[name][m][wk];
            if (d) dataToExport.push([stt++, name, wk, d.score, getRanking(d.score), d.advantages, d.issues]);
          }
        }
      }
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ThiDua");
      XLSX.writeFile(wb, `ThiDua_${m.replace(" ", "_")}_${type}.xlsx`);
    };

    document.addEventListener("DOMContentLoaded", () => {
      populateSelectors();
      listenForDataChanges();
    });
  </script>
</body>
</html>
