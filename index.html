<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sổ Theo Dõi Thi Đua - Lớp 6B0</title>

  <!-- Tailwind & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- XLSX for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body{ font-family:'Inter',sans-serif; background:#f9fafb; }
    .award-card{ background:#fff; border-radius:12px; padding:1rem; box-shadow:0 4px 6px rgba(0,0,0,.08); transition:transform .2s }
    .award-card:hover{ transform:translateY(-3px) }
    textarea{ min-height:48px }
  </style>
</head>
<body class="p-4 md:p-6">

  <!-- Header -->
  <div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl shadow-lg p-6 mb-6">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold">📘 Sổ Theo Dõi Thi Đua - Lớp 6B0</h1>
        <p class="text-indigo-100 mt-1 text-lg">Năm học 2025 - 2026</p>
      </div>
      <div class="flex gap-2">
        <button onclick="exportExcel('week')" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg shadow">📥 Xuất Excel (Tuần)</button>
        <button onclick="exportExcel('month')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">📥 Xuất Excel (Tháng)</button>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="flex flex-wrap items-center gap-3 mb-6">
    <select id="month-select" class="p-2 rounded border border-gray-300 bg-white"></select>
    <select id="week-select" class="p-2 rounded border border-gray-300 bg-white"></select>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full">
      <thead class="bg-indigo-50">
        <tr>
          <th class="px-4 py-2 text-left font-bold">Học sinh</th>
          <th class="px-2 py-2 text-center font-bold w-20">Điểm</th>
          <th class="px-2 py-2 text-center font-bold w-28">Xếp loại</th>
          <th class="px-4 py-2 font-bold">👍 Ưu điểm</th>
          <th class="px-4 py-2 font-bold">✏️ Cần cố gắng</th>
          <th class="px-2 py-2 text-center font-bold w-20">✨</th>
          <th class="px-2 py-2 text-center font-bold w-16">🗑️</th>
        </tr>
      </thead>
      <tbody id="student-table-body" class="divide-y divide-gray-100"></tbody>
    </table>
  </div>

  <!-- Awards -->
  <div class="mt-10 text-center">
    <button onclick="generateAwards()" class="bg-gradient-to-r from-amber-400 to-orange-500 text-white px-6 py-3 rounded-lg font-bold shadow hover:scale-105">
      🏆 Tổng kết & Danh hiệu tuần
    </button>
    <div id="awards-container" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
  </div>

  <!-- Firebase App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteField
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // === Firebase config ===
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    // === Danh sách học sinh ===
    const studentList = [
      "Nguyễn Đặng Minh An","Cung Đức Anh","Trần Quỳnh Anh","Nguyễn Diệp Anh","Hoàng Mai Anh","Nguyễn Huy Bảo Anh",
      "Nguyễn Gia Bảo","Trịnh Quang Bảo","Lại Thảo Chi","Phạm Lam Chi","Nguyễn Khánh Chi","Nguyễn Đỗ Minh Chí",
      "Phạm Khương Duy","Trần Nguyên Duy","Đỗ Quốc Đạt","Lê Tiến Đạt","Quách Trung Đức","Phạm Minh Đức",
      "Lại Tiến Đức","Trần Ngọc Hân","Cao Hoàng","Cung Đức Huy","Nguyễn Minh Khuê","Hoàng Mi Lan",
      "Vũ My Lan","Đàm Gia Linh","Lê Thảo Linh","Đặng Thành Minh","Vương Quang Minh","Vũ Trần Tiến Minh",
      "Đầu Đại Minh","Đặng Gia Minh","Ngô Hoàng My","Đặng Kim Ngân","Nguyễn Khánh Ngọc","Bùi Bảo Nguyên",
      "Lý Hoàng Minh Nhật","Ngô Hải Minh","Dương Yến Nhi","Vũ Khánh Nhi","Trịnh Nam Phong","Nguyễn Hà Phương",
      "Dương Đại Quang","Mai Tiến Thành","Trần Ngọc Thảo","Đặng Anh Thư","Nguyễn Quang Thiện","Nguyễn Đình Thi",
      "Trần Phương Thảo","Trịnh Ngọc Minh Trang","Nguyễn Bảo Trâm","Nguyễn Đức Trí","Trần Trung","Trần Quang Vinh",
      "Lương Uyên Bảo Trân","Nguyễn Quang Vinh","Nguyễn Minh Trí","Nguyễn Quang Huy"
    ];

    const months = ["Tháng 9","Tháng 10","Tháng 11","Tháng 12","Tháng 1","Tháng 2","Tháng 3","Tháng 4","Tháng 5"];
    const weeks  = ["Tuần 1","Tuần 2","Tuần 3","Tuần 4","Tuần 5"];

    let studentData = {};

    function getRanking(score){
      if (score === null || score === "") return {rank:"Chưa có", color:"bg-gray-100 text-gray-600"};
      if (score >= 87) return {rank:"Xuất sắc", color:"bg-green-100 text-green-800"};
      if (score >= 80) return {rank:"Tốt",      color:"bg-blue-100 text-blue-800"};
      if (score >= 65) return {rank:"Khá",      color:"bg-yellow-100 text-yellow-800"};
      if (score >= 50) return {rank:"Đạt",      color:"bg-orange-100 text-orange-800"};
      return {rank:"Chưa đạt", color:"bg-red-100 text-red-800"};
    }

    function generateAdvice(adv, iss){
      let s = "";
      if (adv) s += `Cô khen con ${adv.trim()}. `;
      if (iss) s += `Nhưng cần chú ý: ${iss.trim()}. `;
      if (!adv && !iss) s = "Cô mong con nỗ lực hơn trong tuần tới nhé.";
      return s.trim();
    }

    const monthSelect = document.getElementById("month-select");
    const weekSelect  = document.getElementById("week-select");
    const tableBody   = document.getElementById("student-table-body");
    const awardsContainer = document.getElementById("awards-container");

    months.forEach(m => { const o = document.createElement("option"); o.value=m; o.textContent=m; monthSelect.appendChild(o); });
    weeks.forEach(w  => { const o = document.createElement("option"); o.value=w; o.textContent=w; weekSelect.appendChild(o); });

    monthSelect.value = "Tháng 9";
    weekSelect.value  = "Tuần 1";
    monthSelect.addEventListener("change", renderTable);
    weekSelect.addEventListener("change", renderTable);

    function renderTable(){
      const m = monthSelect.value;
      const w = weekSelect.value;
      tableBody.innerHTML = "";

      studentList.forEach((name, idx) => {
        if (!studentData[name]) studentData[name] = {};
        if (!studentData[name][m]) studentData[name][m] = {};
        if (!studentData[name][m][w]) studentData[name][m][w] = { score:null, adv:"", iss:"", advice:"" };

        const d = studentData[name][m][w];
        const rk = getRanking(d.score);

        const tr = document.createElement("tr");
        tr.className = idx % 2 === 0 ? "bg-white" : "bg-gray-50";
        tr.innerHTML = `
          <td class="px-4 py-2">${name}</td>
          <td class="px-2 py-2 text-center">
            <input type="number" value="${d.score ?? ""}" class="w-16 p-1 border rounded text-center"
              onchange="updateData('${name}','score',this.value)" />
          </td>
          <td class="px-2 py-2 text-center">
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${rk.color}">${rk.rank}</span>
          </td>
          <td class="px-4 py-2">
            <textarea class="w-full border rounded px-2 py-1 text-green-800"
              onchange="updateData('${name}','adv',this.value)">${d.adv ?? ""}</textarea>
          </td>
          <td class="px-4 py-2">
            <textarea class="w-full border rounded px-2 py-1 text-pink-600"
              onchange="updateData('${name}','iss',this.value)">${d.iss ?? ""}</textarea>
          </td>
          <td class="px-2 py-2 text-center">
            <button class="text-2xl hover:scale-125 transition" onclick="getAdvice('${name}')">✨</button>
          </td>
          <td class="px-2 py-2 text-center">
            <button class="text-lg hover:scale-125 transition text-red-500" onclick="clearData('${name}')">🗑️</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    let saveTimer;
    window.updateData = (name, field, value) => {
      const m = monthSelect.value, w = weekSelect.value;
      if (field === "score") value = value === "" ? null : Number(value);
      if (!studentData[name]) studentData[name] = {};
      if (!studentData[name][m]) studentData[name][m] = {};
      if (!studentData[name][m][w]) studentData[name][m][w] = { score:null, adv:"", iss:"", advice:"" };
      studentData[name][m][w][field] = value;

      const path = `studentData.${name}.${m}.${w}.${field}`;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        setDoc(dataDocRef, { [path]: value }, { merge: true });
      }, 250);
      renderTable();
    };

    window.getAdvice = (name) => {
      const m = monthSelect.value, w = weekSelect.value;
      const d = studentData[name]?.[m]?.[w] || { adv:"", iss:"" };
      const advice = generateAdvice(d.adv, d.iss);
      const path = `studentData.${name}.${m}.${w}.advice`;
      setDoc(dataDocRef, { [path]: advice }, { merge: true });
      alert(`Nhận xét của Cô Hoa:\n\n${advice}`);
    };

    // === Xoá dữ liệu của 1 học sinh trong tuần ===
    window.clearData = async (name) => {
      const m = monthSelect.value, w = weekSelect.value;
      if (!confirm(`Xoá toàn bộ dữ liệu tuần này của ${name}?`)) return;
      await updateDoc(dataDocRef, { [`studentData.${name}.${m}.${w}`]: deleteField() });
    };

    onSnapshot(dataDocRef, (snap) => {
      studentData = snap.exists() ? (snap.data().studentData || {}) : {};
      renderTable();
    });

    window.exportExcel = (type) => {
      const m = monthSelect.value, w = weekSelect.value;
      let aoa;
      if (type === "week") {
        aoa = [["STT","Họ và tên","Điểm","Xếp loại","Ưu điểm","Cần cố gắng","Nhận xét"]];
      } else {
        aoa = [["STT","Họ và tên","Tuần","Điểm","Xếp loại","Ưu điểm","Cần cố gắng","Nhận xét"]];
      }
      let stt=1;
      studentList.forEach((name) => {
        const mData = studentData[name]?.[m] || {};
        if (type==="week") {
          const d = mData[w]; if (!d) return;
          aoa.push([stt++, name, d.score??"", getRanking(d.score).rank, d.adv??"", d.iss??"", d.advice??""]);
        } else {
          weeks.forEach((wk)=> {
            const d=mData[wk]; if (!d) return;
            aoa.push([stt++, name, wk, d.score??"", getRanking(d.score).rank, d.adv??"", d.iss??"", d.advice??""]);
          });
        }
      });
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ThiDua");
      XLSX.writeFile(wb, `ThiDua_${m}_${type}.xlsx`);
    };

    window.generateAwards = () => {
      const m = monthSelect.value, w = weekSelect.value;
      const awards={excellent:[],hardworking:[],progressive:[],disciplined:[]};
      studentList.forEach((name)=>{
        const cur=studentData[name]?.[m]?.[w]; if (!cur) return;
        if (cur.score>=87) awards.excellent.push(name);
        if ((cur.adv||"").toLowerCase().includes("phát biểu")||(cur.adv||"").includes("10")) awards.hardworking.push(name);
        if (!cur.iss) awards.disciplined.push(name);
        const idx=weeks.indexOf(w);
        if (idx>0){ const prev=studentData[name]?.[m]?.[weeks[idx-1]];
          if (prev && cur.score!=null && prev.score!=null && cur.score>prev.score)
            awards.progressive.push(`${name} (+${cur.score-prev.score}đ)`);
        }
      });
      awardsContainer.innerHTML="";
      function box(title,list){
        const div=document.createElement("div"); div.className="award-card";
        div.innerHTML=`<h3 class="font-bold mb-2">${title}</h3>`+
        (list.length?`<ul class="list-disc list-inside">${list.map(n=>`<li>${n}</li>`).join("")}</ul>`:
        `<p class="text-gray-400 italic">Chưa có</p>`);
        awardsContainer.appendChild(div);
      }
      box("Ngôi sao học tập ⭐",awards.excellent);
      box("Ong chăm chỉ 🐝",awards.hardworking);
      box("Chiến binh tiến bộ 🚀",awards.progressive);
      box("Hiệp sĩ nề nếp 🛡️",awards.disciplined);
    };

    renderTable();
  </script>
</body>
</html>
