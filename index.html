<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sá»• Theo DÃµi Thi Äua - Lá»›p 6B0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
    }

    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4f46e5;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {transform: rotate(0deg)}
      100% {transform: rotate(360deg)}
    }
  </style>
</head>

<body class="p-4 md:p-6">
  <div id="app" class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-2xl shadow-lg p-6 mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold">ğŸ“˜ Sá»• Theo DÃµi Thi Äua - Lá»›p 6B0</h1>
      <p class="text-indigo-100 mt-2">NÄƒm há»c 2024 - 2025</p>
    </div>

    <!-- Controls -->
    <div class="flex flex-wrap gap-3 justify-center mb-6">
      <select id="month-select" class="border p-2 rounded-lg shadow bg-white"></select>
      <select id="week-select" class="border p-2 rounded-lg shadow bg-white"></select>
      <button onclick="save()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg shadow">ğŸ’¾ LÆ°u dá»¯ liá»‡u</button>
      <button onclick="exportExcel('week')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow">ğŸ“¤ Xuáº¥t Excel (Tuáº§n)</button>
      <button onclick="exportExcel('month')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow">ğŸ“¤ Xuáº¥t Excel (ThÃ¡ng)</button>
    </div>

    <!-- Student Table -->
    <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-indigo-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Há»c sinh</th>
            <th class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase">Äiá»ƒm</th>
            <th class="px-2 py-3 text-center text-xs font-bold text-gray-600 uppercase">Xáº¿p loáº¡i</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">ğŸ‘ Æ¯u Ä‘iá»ƒm</th>
            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">âœï¸ Cáº§n cá»‘ gáº¯ng</th>
          </tr>
        </thead>
        <tbody id="student-table-body" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loading-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
      <div class="loader mx-auto"></div>
      <p id="loading-text" class="mt-3 text-gray-700 font-medium">Äang lÆ°u dá»¯ liá»‡u...</p>
    </div>
  </div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Firebase config cá»§a báº¡n
    const firebaseConfig = {
      apiKey: "AIzaSyBnKAyxQmObrNr8BtKz50uGpDDcHHFSJxA",
      authDomain: "banthidua6b0.firebaseapp.com",
      projectId: "banthidua6b0",
      storageBucket: "banthidua6b0.appspot.com",
      messagingSenderId: "743525041700",
      appId: "1:743525041700:web:c76f51122303762212bab1",
      measurementId: "G-KK8BHC3E12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dataDocRef = doc(db, "classData", "lop6B0");

    // Danh sÃ¡ch há»c sinh (57 HS + Nguyá»…n Minh TrÃ­ + Nguyá»…n Quang Huy)
    const studentList = [
      { name: "Nguyá»…n Äáº·ng Minh An", gender: "Ná»¯" },
      { name: "Cung Äá»©c Anh", gender: "Nam" },
      { name: "Tráº§n Quá»³nh Anh", gender: "Ná»¯" },
      { name: "Nguyá»…n Diá»‡p Anh", gender: "Ná»¯" },
      { name: "HoÃ ng Mai Anh", gender: "Ná»¯" },
      { name: "Nguyá»…n Huy Báº£o Anh", gender: "Nam" },
      { name: "Nguyá»…n Gia Báº£o", gender: "Nam" },
      { name: "Trá»‹nh Quang Báº£o", gender: "Nam" },
      { name: "Láº¡i Tháº£o Chi", gender: "Ná»¯" },
      { name: "Pháº¡m Lam Chi", gender: "Ná»¯" },
      { name: "Nguyá»…n KhÃ¡nh Chi", gender: "Ná»¯" },
      { name: "Nguyá»…n Äá»— Minh ChÃ­", gender: "Nam" },
      { name: "Pháº¡m KhÆ°Æ¡ng Duy", gender: "Nam" },
      { name: "Tráº§n NguyÃªn Duy", gender: "Nam" },
      { name: "Äá»— Quá»‘c Äáº¡t", gender: "Nam" },
      { name: "LÃª Tiáº¿n Äáº¡t", gender: "Nam" },
      { name: "QuÃ¡ch Trung Äá»©c", gender: "Nam" },
      { name: "Pháº¡m Minh Äá»©c", gender: "Nam" },
      { name: "Láº¡i Tiáº¿n Äá»©c", gender: "Nam" },
      { name: "Tráº§n Ngá»c HÃ¢n", gender: "Ná»¯" },
      { name: "Cao HoÃ ng", gender: "Nam" },
      { name: "Cung Äá»©c Huy", gender: "Nam" },
      { name: "Nguyá»…n Minh KhuÃª", gender: "Ná»¯" },
      { name: "HoÃ ng Mi Lan", gender: "Ná»¯" },
      { name: "VÅ© My Lan", gender: "Ná»¯" },
      { name: "ÄÃ m Gia Linh", gender: "Ná»¯" },
      { name: "LÃª Tháº£o Linh", gender: "Ná»¯" },
      { name: "Äáº·ng ThÃ nh Minh", gender: "Nam" },
      { name: "VÆ°Æ¡ng Quang Minh", gender: "Nam" },
      { name: "VÅ© Tráº§n Tiáº¿n Minh", gender: "Nam" },
      { name: "Äáº§u Äáº¡i Minh", gender: "Nam" },
      { name: "Äáº·ng Gia Minh", gender: "Nam" },
      { name: "NgÃ´ HoÃ ng My", gender: "Ná»¯" },
      { name: "Äáº·ng Kim NgÃ¢n", gender: "Ná»¯" },
      { name: "Nguyá»…n KhÃ¡nh Ngá»c", gender: "Ná»¯" },
      { name: "BÃ¹i Báº£o NguyÃªn", gender: "Nam" },
      { name: "LÃ½ HoÃ ng Minh Nháº­t", gender: "Nam" },
      { name: "NgÃ´ Háº£i Minh", gender: "Nam" },
      { name: "DÆ°Æ¡ng Yáº¿n Nhi", gender: "Ná»¯" },
      { name: "VÅ© KhÃ¡nh Nhi", gender: "Ná»¯" },
      { name: "Trá»‹nh Nam Phong", gender: "Nam" },
      { name: "Nguyá»…n HÃ  PhÆ°Æ¡ng", gender: "Ná»¯" },
      { name: "DÆ°Æ¡ng Äáº¡i Quang", gender: "Nam" },
      { name: "Mai Tiáº¿n ThÃ nh", gender: "Nam" },
      { name: "Tráº§n Ngá»c Tháº£o", gender: "Ná»¯" },
      { name: "Äáº·ng Anh ThÆ°", gender: "Ná»¯" },
      { name: "Nguyá»…n Quang Thiá»‡n", gender: "Nam" },
      { name: "Nguyá»…n ÄÃ¬nh Thi", gender: "Nam" },
      { name: "Tráº§n PhÆ°Æ¡ng Tháº£o", gender: "Ná»¯" },
      { name: "Trá»‹nh Ngá»c Minh Trang", gender: "Ná»¯" },
      { name: "Nguyá»…n Báº£o TrÃ¢m", gender: "Ná»¯" },
      { name: "NguyÃªÌƒn ÄÆ°Ìc TriÌ", gender: "Nam" },
      { name: "Nguyá»…n Minh TrÃ­", gender: "Nam" },
      { name: "Nguyá»…n Quang Huy", gender: "Nam" },
      { name: "Tráº§n Trung", gender: "Nam" },
      { name: "Tráº§n Quang Vinh", gender: "Nam" },
      { name: "LÆ°Æ¡ng UyÃªn Báº£o TrÃ¢n", gender: "Ná»¯" },
      { name: "Nguyá»…n Quang Vinh", gender: "Nam" }
    ];

    const months = Array.from({ length: 9 }, (_, i) => `ThÃ¡ng ${i + 9 > 12 ? i + 9 - 12 : i + 9}`);
    const weeks = ["Tuáº§n 1", "Tuáº§n 2", "Tuáº§n 3", "Tuáº§n 4", "Tuáº§n 5"];
    let studentData = {};

    function generateInitialData() {
      const initial = {};
      studentList.forEach(s => {
        initial[s.name] = {};
        months.forEach(m => {
          initial[s.name][m] = {};
          weeks.forEach(w => {
            initial[s.name][m][w] = { score: null, advantages: "", issues: "" };
          });
        });
      });
      return initial;
    }

    function getRanking(score) {
      if (score === null || score === "") return "ChÆ°a cÃ³";
      if (score >= 87) return "Xuáº¥t sáº¯c";
      if (score >= 80) return "Tá»‘t";
      if (score >= 65) return "KhÃ¡";
      if (score >= 50) return "Äáº¡t";
      return "ChÆ°a Ä‘áº¡t";
    }

    async function save() {
      document.getElementById("loading-text").textContent = "Äang lÆ°u dá»¯ liá»‡u...";
      document.getElementById("loading-modal").classList.remove("hidden");
      document.getElementById("loading-modal").classList.add("flex");
      await setDoc(dataDocRef, { studentData }, { merge: true });
      setTimeout(() => {
        document.getElementById("loading-modal").classList.add("hidden");
        document.getElementById("loading-modal").classList.remove("flex");
        alert("âœ… Dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng!");
      }, 800);
    }

    function listenForDataChanges() {
      onSnapshot(dataDocRef, (docSnap) => {
        if (docSnap.exists()) {
          studentData = docSnap.data().studentData;
        } else {
          studentData = generateInitialData();
          save();
        }
        renderTable();
      });
    }

    const monthSelect = document.getElementById("month-select");
    const weekSelect = document.getElementById("week-select");
    const tableBody = document.getElementById("student-table-body");

    function populateSelectors() {
      months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m; opt.textContent = m;
        monthSelect.appendChild(opt);
      });
      weeks.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w; opt.textContent = w;
        weekSelect.appendChild(opt);
      });
      monthSelect.addEventListener("change", renderTable);
      weekSelect.addEventListener("change", renderTable);
      monthSelect.value = months[0];
      weekSelect.value = weeks[0];
    }

    function renderTable() {
      if (!monthSelect.value || !weekSelect.value) return;
      tableBody.innerHTML = "";
      studentList.forEach((s, idx) => {
        const data = studentData[s.name]?.[monthSelect.value]?.[weekSelect.value] || {};
        const ranking = getRanking(data.score);
        const row = document.createElement("tr");
        row.className = idx % 2 === 0 ? "bg-white" : "bg-gray-50";
        row.innerHTML = `
          <td class="px-4 py-2">
            <input type="text" value="${s.name}" onchange="updateData('${s.name}', 'name', this.value)" 
              class="w-full border rounded px-2 py-1 text-gray-700 font-medium">
          </td>
          <td class="px-2 py-2 text-center">
            <input type="number" value="${data.score ?? ""}" 
              onchange="updateData('${s.name}', 'score', this.value)" 
              class="w-20 border rounded px-2 py-1 text-center font-semibold">
          </td>
          <td class="px-2 py-2 text-center">
            <span class="px-3 py-1 rounded-full text-sm font-semibold ${ranking === 'Xuáº¥t sáº¯c' ? 'bg-green-100 text-green-700' :
              ranking === 'Tá»‘t' ? 'bg-blue-100 text-blue-700' :
              ranking === 'KhÃ¡' ? 'bg-yellow-100 text-yellow-700' :
              ranking === 'Äáº¡t' ? 'bg-orange-100 text-orange-700' :
              'bg-gray-100 text-gray-500'}">${ranking}</span>
          </td>
          <td class="px-4 py-2">
            <textarea onchange="updateData('${s.name}', 'advantages', this.value)" 
              class="w-full border rounded px-2 py-1 text-green-700">${data.advantages ?? ""}</textarea>
          </td>
          <td class="px-4 py-2">
            <textarea onchange="updateData('${s.name}', 'issues', this.value)" 
              class="w-full border rounded px-2 py-1 text-pink-600">${data.issues ?? ""}</textarea>
          </td>`;
        tableBody.appendChild(row);
      });
    }

    window.updateData = (studentName, field, value) => {
      const m = monthSelect.value;
      const w = weekSelect.value;
      if (!studentData[studentName]) studentData[studentName] = {};
      if (!studentData[studentName][m]) studentData[studentName][m] = {};
      if (!studentData[studentName][m][w]) studentData[studentName][m][w] = {};
      if (field === "score") value = value === "" ? null : Number(value);
      if (field === "name") {
        studentData[value] = studentData[studentName];
        delete studentData[studentName];
      } else {
        studentData[studentName][m][w][field] = value;
      }
      save();
      renderTable();
    };

    window.exportExcel = async (type) => {
      const m = monthSelect.value, w = weekSelect.value;
      const dataToExport = [];
      const header = ["STT", "Há» vÃ  tÃªn", "Äiá»ƒm", "Xáº¿p loáº¡i", "Æ¯u Ä‘iá»ƒm", "Cáº§n cá»‘ gáº¯ng"];
      if (type === "month") header.splice(2, 0, "Tuáº§n");
      dataToExport.push(header);
      let stt = 1;
      for (const s of studentList) {
        if (type === "week") {
          const d = studentData[s.name][m][w];
          if (d) dataToExport.push([stt++, s.name, d.score, getRanking(d.score), d.advantages, d.issues]);
        } else {
          for (const wk of weeks) {
            const d = studentData[s.name][m][wk];
            if (d) dataToExport.push([stt++, s.name, wk, d.score, getRanking(d.score), d.advantages, d.issues]);
          }
        }
      }
      const ws = XLSX.utils.aoa_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ThiDua");
      XLSX.writeFile(wb, `ThiDua_${m.replace(" ", "_")}_${type}.xlsx`);
    };

    document.addEventListener("DOMContentLoaded", () => {
      populateSelectors();
      listenForDataChanges();
    });
  </script>
</body>
</html>
